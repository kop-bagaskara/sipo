<!-- Form Permohonan Tidak Masuk Kerja -->
<!-- Enhanced Information & Guide Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="accordion" id="reminderAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="reminderHeading">
                    <button class="btn btn-info accordion-button collapsed" style="width: 100%;" type="button"
                        data-toggle="collapse" data-target="#reminderCollapse" aria-expanded="false"
                        aria-controls="reminderCollapse">
                        <i class="mdi mdi-information-outline me-2"></i>
                        <strong>Reminder & Informasi Penting Perizinan</strong>
                    </button>
                </h2>
                <div id="reminderCollapse" class="accordion-collapse collapse" aria-labelledby="reminderHeading"
                    data-parent="#reminderAccordion">
                    <div class="accordion-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <strong><i class="mdi mdi-airplane me-2"></i>Dinas</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li><strong>Deadline:</strong> H-1 (1 hari sebelum tanggal izin)</li>
                                            <li>Wajib mengisi Tujuan Dinas</li>
                                            <li>Tidak mengurangi jatah cuti tahunan</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <strong><i class="mdi mdi-calendar-check me-2"></i>Cuti Tahunan</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li><strong>Deadline:</strong> H-7 (7 hari sebelum tanggal izin)</li>
                                            <li>Mengurangi jatah cuti tahunan</li>
                                            <li>Sisa cuti akan divalidasi saat pengajuan</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <strong><i class="mdi mdi-star-circle me-2"></i>Cuti Khusus</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li>Tidak mengurangi jatah cuti tahunan</li>
                                            <li><strong>Kategori tersedia:</strong>
                                                <ul class="mt-2 mb-0">
                                                    <li>Pernikahan Karyawan (3 hari)</li>
                                                    <li>Mengkhitankan/Membaptis Anak (2 hari)</li>
                                                    <li>Pernikahan Anak Karyawan (2 hari)</li>
                                                    <li>Kematian Keluarga (1-2 hari sesuai kategori)</li>
                                                    <li>Persalinan Istri/Keguguran (2 hari)</li>
                                                    <li>Lainnya (isi keterangan sendiri)</li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <strong><i class="mdi mdi-heart-pulse me-2"></i>Cuti Haid</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li><strong>Deadline:</strong> Maksimal H+1 (1 hari setelah tanggal izin)
                                            </li>
                                            <li>Khusus karyawan wanita</li>
                                            <li>Wajib melampirkan surat dokter</li>
                                            <li>Tidak mengurangi jatah cuti tahunan</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <strong><i class="mdi mdi-baby-face-outline me-2"></i>Cuti Hamil</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li><strong>Rentang:</strong> 1.5 bulan sebelum HPL sampai 1.5 bulan setelah
                                                HPL</li>
                                            <li>Khusus karyawan wanita</li>
                                            <li>Wajib mengisi HPL (Hari Perkiraan Lahir)</li>
                                            <li>Tidak mengurangi jatah cuti tahunan</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-secondary">
                                    <div class="card-header bg-secondary text-white">
                                        <strong><i class="mdi mdi-account-check me-2"></i>Ijin</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li>Pilihan pengajuan: <strong>Dadakan</strong> atau <strong>H-7</strong>
                                            </li>
                                            <li>Wajib mengisi keterangan izin secara detail</li>
                                            <li>Maksimal H+1 atau H-1</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-dark">
                                    <div class="card-header bg-dark text-white">
                                        <strong><i class="mdi mdi-hospital-box me-2"></i>Sakit</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li>Wajib melampirkan surat dokter</li>
                                            <li>Pengajuan dapat dilakukan saat sakit atau H+1 ketika masuk kerja</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="mdi mdi-alert-circle-outline me-2"></i>
                            <strong>Catatan Penting:</strong> Pastikan untuk mengajukan izin sesuai dengan deadline yang
                            ditentukan. Pengajuan yang terlambat akan ditolak oleh sistem.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .hover-lift {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hover-lift:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }
    .space-y-2 > * + * {
        margin-top: 0.5rem;
    }
    #reminderCollapse .collapse.show + .card-body {
        border-top: none;
    }
    #accordionIcon {
        transition: transform 0.3s ease;
    }
    #reminderCollapse:not(.show) #accordionIcon {
        transform: rotate(-90deg);
    }
</style>

<!-- Data Pemohon Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0 text-primary">
                    <i class="mdi mdi-account-circle me-2"></i>Data Pemohon
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">
                            <i class="mdi mdi-account me-1 text-muted"></i>Nama
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" name="name" class="form-control @error('name') is-invalid @enderror"
                            value="{{ old('name', $data['name'] ?? auth()->user()->name) }}" required readonly>
                        @error('name')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">
                            <i class="mdi mdi-gender-male-female me-1 text-muted"></i>Jenis Kelamin
                        </label>
                        <input type="text" name="gender" class="form-control"
                            value="{{ old('gender', $data['employee_gender'] ?? '') }}" required readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">
                            <i class="mdi mdi-office-building me-1 text-muted"></i>Bagian
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" name="department" class="form-control @error('department') is-invalid @enderror"
                            value="{{ old('department', $data['department'] ?? (auth()->user()->divisiUser->divisi ?? '')) }}" required
                            readonly>
                        @error('department')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Perizinan Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-primary">
                        <i class="mdi mdi-file-document-edit me-2"></i>Detail Perizinan
                    </h5>
                    <span class="badge bg-light text-secondary border">
                        <i class="mdi mdi-information-outline me-1"></i>Lihat panduan di atas untuk info lengkap
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Jenis Izin -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="mdi mdi-calendar-star me-1 text-muted"></i>Jenis Izin
                            <span class="text-danger">*</span>
                            <i class="mdi mdi-help-circle text-info ms-1" data-toggle="tooltip"
                                data-placement="right" title="Pilih jenis izin atau cuti yang sesuai dengan kebutuhan Anda"></i>
                        </label>
                        <select name="absence_type" id="absence_type"
                            class="form-select form-control @error('absence_type') is-invalid @enderror" required>
                            <option value="">-- Pilih Jenis Izin --</option>
                            @if (isset($data['absenceSettings']))
                                @foreach ($data['absenceSettings'] as $absenceType => $setting)
                                    <option value="{{ $absenceType }}" {{ old('absence_type') == $absenceType ? 'selected' : '' }}>
                                        {{ $absenceType }}
                                    </option>
                                @endforeach
                            @endif
                        </select>
                        @error('absence_type')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                        <div class="form-text text-muted">
                            <i class="mdi mdi-lightbulb-on-outline text-warning me-1"></i>
                            Pilih jenis izin yang sesuai, informasi deadline akan muncul otomatis
                        </div>
                        <!-- Info Deadline -->
                        <div id="deadline_info" class="mt-2" style="display: none;">
                            <div class="alert alert-info py-2 px-3 mb-0 border-0">
                                <i class="mdi mdi-clock-outline me-1"></i>
                                <strong>Deadline Pengajuan:</strong> <span id="deadline_text" class="small"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Durasi -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="mdi mdi-clock-outline me-1 text-muted"></i>Durasi
                            <span class="text-danger">*</span>
                            <i class="mdi mdi-help-circle text-info ms-1" data-toggle="tooltip"
                                data-placement="right" title="Masukkan jumlah hari izin/cuti yang dibutuhkan"></i>
                        </label>
                        <div class="input-group">
                            <input type="number" name="duration_days" id="duration_days"
                                class="form-control @error('duration_days') is-invalid @enderror"
                                value="{{ old('duration_days', $data['duration_days'] ?? '') }}" min="1" required
                                placeholder="Masukkan jumlah hari">
                            <span class="input-group-text bg-light">
                                <i class="mdi mdi-calendar-clock"></i> hari
                            </span>
                        </div>
                        @error('duration_days')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                        <div class="form-text text-muted">
                            <i class="mdi mdi-information-outline me-1"></i>
                            Pastikan durasi sesuai dengan kebutuhan dan perusahaan memperbolehkan
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sub-kategori Cuti Khusus (muncul jika Cuti Khusus dipilih) -->
<div class="row mb-3" id="cuti_khusus_category" style="display: none;">
    <div class="col-12">
        <div class="card border-warning shadow-sm">
            <div class="card-header bg-warning bg-opacity-10 border-warning">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-warning-emphasis">
                        <i class="mdi mdi-star-circle me-2"></i>Kategori Cuti Khusus
                        <span class="text-danger">*</span>
                    </h6>
                    <span class="badge bg-warning text-dark">Bebas Potong Cuti</span>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-warning border-0 mb-3">
                    <i class="mdi mdi-information-outline me-2"></i>
                    <strong>Cuti Khusus</strong> adalah cuti yang diberikan untuk keperluan tertentu dan <strong>tidak memotong jatah cuti tahunan</strong>. Pastikan kategori yang dipilih sesuai dengan keadaan yang sebenarnya.
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            Pilih Kategori
                            <i class="mdi mdi-help-circle text-info ms-1" data-toggle="tooltip"
                                data-placement="right" title="Pilih kategori cuti khusus yang sesuai dengan kebutuhan Anda"></i>
                        </label>
                        <select name="cuti_khusus_category" id="cuti_khusus_category_select" class="form-select form-control">
                            <option value="">-- Pilih Kategori --</option>
                            @if (isset($data['absenceSettings']['CUTI KHUSUS']['master_sub_absence']))
                                @foreach ($data['absenceSettings']['CUTI KHUSUS']['master_sub_absence'] as $sub)
                                    <option value="{{ $sub['name'] }}"
                                        {{ old('cuti_khusus_category') == $sub['name'] ? 'selected' : '' }}>
                                        {{ $sub['name'] }} ({{ $sub['duration_days'] }} hari)
                                    </option>
                                @endforeach
                            @endif
                            <option value="Lainnya" {{ old('cuti_khusus_category') == 'Lainnya' ? 'selected' : '' }}>Lainnya</option>
                        </select>
                        <div class="form-text text-muted mt-1">
                            <i class="mdi mdi-lightbulb-on-outline me-1"></i>
                            Durasi otomatis terisi berdasarkan kategori
                        </div>
                    </div>
                    <div class="col-md-6" id="cuti_khusus_other" style="display: none;">
                        <label class="form-label fw-semibold">
                            Keterangan Lainnya <span class="text-danger">*</span>
                            <i class="mdi mdi-help-circle text-info ms-1" data-toggle="tooltip"
                                data-placement="right" title="Jelaskan detail kategori cuti khusus lainnya"></i>
                        </label>
                        <input type="text" name="cuti_khusus_other_text" id="cuti_khusus_other_text" class="form-control"
                            value="{{ old('cuti_khusus_other_text', '') }}" placeholder="Tuliskan keterangan cuti khusus secara detail">
                        <div class="form-text text-muted mt-1">
                            <i class="mdi mdi-alert-outline me-1"></i>
                            Sertakan detail yang jelas untuk persetujuan yang lebih cepat
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Field Dinas (muncul jika Dinas dipilih) -->
<div class="row mb-3" id="dinas_purpose" style="display: none;">
    <div class="col-12">
        <div class="card border-info shadow-sm">
            <div class="card-header bg-info bg-opacity-10 border-info">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-info-emphasis">
                        <i class="mdi mdi-airplane me-2"></i>Detail Dinas Luar Kota
                    </h6>
                    <span class="badge bg-info text-white">Tidak Potong Cuti</span>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info border-0 mb-3">
                    <div class="d-flex align-items-start">
                        <i class="mdi mdi-information-outline me-2 fs-5"></i>
                        <div>
                            <strong>Dinas Luar Kota</strong> adalah perjalanan kerja yang telah disetujui oleh atasan.
                            <div class="small mt-1">
                                <i class="mdi mdi-check-circle-outline me-1"></i>Wajib melampirkan surat tugas atau undangan resmi
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            Kategori Keperluan <span class="text-danger">*</span>
                            <i class="mdi mdi-help-circle text-info ms-1" data-toggle="tooltip"
                                data-placement="right" title="Pilih kategori keperluan dinas yang sesuai"></i>
                        </label>
                        <select name="dinas_category" id="dinas_category"
                            class="form-select form-control @error('dinas_category') is-invalid @enderror" required>
                            <option value="">-- Pilih Kategori --</option>
                            <option value="VISIT JAKARTA" {{ old('dinas_category') == 'VISIT JAKARTA' ? 'selected' : '' }}>VISIT JAKARTA</option>
                            <option value="JAWA TENGAH" {{ old('dinas_category') == 'JAWA TENGAH' ? 'selected' : '' }}>JAWA TENGAH</option>
                            <option value="BALI" {{ old('dinas_category') == 'BALI' ? 'selected' : '' }}>BALI</option>
                            <option value="DEMO" {{ old('dinas_category') == 'DEMO' ? 'selected' : '' }}>DEMO</option>
                            <option value="TRAINING" {{ old('dinas_category') == 'TRAINING' ? 'selected' : '' }}>TRAINING</option>
                            <option value="JOB FAIR" {{ old('dinas_category') == 'JOB FAIR' ? 'selected' : '' }}>JOB FAIR</option>
                            <option value="SEMINAR" {{ old('dinas_category') == 'SEMINAR' ? 'selected' : '' }}>SEMINAR</option>
                            <option value="PSIKOTES" {{ old('dinas_category') == 'PSIKOTES' ? 'selected' : '' }}>PSIKOTES</option>
                            <option value="WORKSHOP" {{ old('dinas_category') == 'WORKSHOP' ? 'selected' : '' }}>WORKSHOP</option>
                        </select>
                        @error('dinas_category')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                        <div class="form-text text-muted">
                            <i class="mdi mdi-lightbulb-on-outline me-1"></i>
                            Pilih kategori yang paling sesuai dengan tujuan dinas
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            Detail Tujuan <span class="text-danger">*</span>
                            <i class="mdi mdi-help-circle text-info ms-1" data-toggle="tooltip"
                                data-placement="right" title="Jelaskan detail lokasi, alamat, dan tujuan dinas"></i>
                        </label>
                        <textarea name="dinas_purpose" id="dinas_purpose_input"
                            class="form-control @error('dinas_purpose') is-invalid @enderror" rows="3"
                            placeholder="Contoh: Kunjungan ke client PT. XYZ di Jakarta untuk demo produk. Alamat: Jl. Sudirman No. 123, Jakarta Selatan." required>{{ old('dinas_purpose', '') }}</textarea>
                        @error('dinas_purpose')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                        <div class="form-text text-muted">
                            <i class="mdi mdi-map-marker me-1"></i>
                            Sertakan: lokasi lengkap, nama client/institusi, dan tujuan kegiatan
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Field Ijin (muncul jika Ijin dipilih) -->
<div class="row mb-3" id="ijin_detail" style="display: none;">
    <div class="col-12">
        <div class="card border-secondary shadow-sm">
            <div class="card-header bg-secondary bg-opacity-10 border-secondary">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-secondary-emphasis">
                        <i class="mdi mdi-account-check me-2"></i>Detail Izin
                    </h6>
                    <span class="badge bg-secondary text-white">Tidak Potong Cuti</span>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-secondary border-0 mb-3">
                    <div class="d-flex align-items-start">
                        <i class="mdi mdi-information-outline me-2 fs-5"></i>
                        <div>
                            <strong>Izin</strong> diberikan untuk keperluan mendesak atau penting yang tidak dapat ditunda.
                            <div class="small mt-1">
                                <i class="mdi mdi-alert-outline me-1"></i>Izin bersifat <strong>insidental</strong> dan wajib disertai penjelasan detail
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            Kategori Izin <span class="text-danger">*</span>
                            <i class="mdi mdi-help-circle text-info ms-1" data-toggle="tooltip"
                                data-placement="right" title="Pilih kategori izin yang sesuai"></i>
                        </label>
                        <select name="ijin_category" id="ijin_category"
                            class="form-select form-control @error('ijin_category') is-invalid @enderror" required>
                            <option value="">-- Pilih Kategori --</option>
                            <option value="KEMATIAN" {{ old('ijin_category') == 'KEMATIAN' ? 'selected' : '' }}>KEMATIAN</option>
                            <option value="ACARA KELUARGA" {{ old('ijin_category') == 'ACARA KELUARGA' ? 'selected' : '' }}>ACARA KELUARGA</option>
                            <option value="PERNIKAHAN" {{ old('ijin_category') == 'PERNIKAHAN' ? 'selected' : '' }}>PERNIKAHAN</option>
                            <option value="KEPENTINGAN PRIBADI" {{ old('ijin_category') == 'KEPENTINGAN PRIBADI' ? 'selected' : '' }}>KEPENTINGAN PRIBADI</option>
                            <option value="KELAHIRAN" {{ old('ijin_category') == 'KELAHIRAN' ? 'selected' : '' }}>KELAHIRAN</option>
                            <option value="KELUARGA SAKIT" {{ old('ijin_category') == 'KELUARGA SAKIT' ? 'selected' : '' }}>KELUARGA SAKIT</option>
                        </select>
                        @error('ijin_category')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                        <div class="form-text text-muted">
                            <i class="mdi mdi-lightbulb-on-outline me-1"></i>
                            Pilih kategori yang paling sesuai dengan keperluan Anda
                        </div>
                    </div>
                    <div class="col-md-6" id="ijin_purpose_field" style="display: none;">
                        <label class="form-label fw-semibold">
                            Detail Keperluan <span class="text-danger">*</span>
                            <i class="mdi mdi-help-circle text-info ms-1" data-toggle="tooltip"
                                data-placement="right" title="Jelaskan detail keperluan izin secara lengkap"></i>
                        </label>
                        <textarea name="ijin_purpose" id="ijin_purpose" class="form-control @error('ijin_purpose') is-invalid @enderror"
                            rows="3" placeholder="Contoh: Izin untuk menghadiri pernikahan saudara di Surabaya. Acara pada hari Sabtu, 25 Januari 2025." required>{{ old('ijin_purpose', '') }}</textarea>
                        @error('ijin_purpose')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                        <div class="form-text text-muted">
                            <i class="mdi mdi-information-outline me-1"></i>
                            Jelaskan: kapan, dimana, dan keperluan apa secara detail
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tanggal & Keperluan Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0 text-primary">
                    <i class="mdi mdi-calendar-range me-2"></i>Periode & Keperluan
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">
                            <i class="mdi mdi-calendar-today me-1 text-muted"></i>Tanggal Awal
                            <span class="text-danger">*</span>
                        </label>
                        <input type="date" name="date_start" id="date_start"
                            class="form-control @error('date_start') is-invalid @enderror"
                            value="{{ old('date_start', $data['date_start'] ?? '') }}" required>
                        @error('date_start')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">
                            <i class="mdi mdi-calendar-check me-1 text-muted"></i>Sampai Tanggal
                            <span class="text-danger">*</span>
                        </label>
                        <input type="date" name="date_end" id="date_end"
                            class="form-control @error('date_end') is-invalid @enderror bg-light"
                            value="{{ old('date_end', $data['date_end'] ?? '') }}" readonly>
                        @error('date_end')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                        <div class="form-text">
                            <i class="mdi mdi-auto-fix me-1"></i>Otomatis dihitung
                        </div>
                    </div>
                    <div class="col-md-4" id="purpose_field">
                        <label class="form-label fw-semibold">
                            <i class="mdi mdi-text-box me-1 text-muted"></i>Keperluan
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" name="purpose" class="form-control @error('purpose') is-invalid @enderror"
                            value="{{ old('purpose', $data['purpose'] ?? '') }}" placeholder="Alasan tidak masuk kerja" required>
                        @error('purpose')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sisa Cuti Tahunan (hanya tampil untuk Cuti Tahunan) -->
<div class="row mb-3" id="remaining_leave_section" style="display: none;">
    <div class="col-12">
        <div class="card border-info shadow-sm">
            <div class="card-body bg-info bg-opacity-5 text-white">
                <div class="d-flex align-items-start mb-3">
                    <div class="flex-shrink-0">
                        <i class="mdi mdi-information-outline fs-3 text-white"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-1 text-white">Informasi Cuti Tahunan</h6>
                        <p class="mb-0 small">Sisa cuti tahunan Anda akan dipotong sesuai durasi cuti yang diajukan.</p>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Sisa Cuti Tahunan</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="mdi mdi-calendar-check"></i></span>
                            <input type="number" name="remaining_annual_leave" id="remaining_annual_leave"
                                class="form-control @error('remaining_annual_leave') is-invalid @enderror bg-white"
                                value="{{ old('remaining_annual_leave', $data['remaining_annual_leave'] ?? ($data['remainingAnnualLeave'] ?? 0)) }}"
                                min="0" readonly>
                            <span class="input-group-text">hari</span>
                        </div>
                        @error('remaining_annual_leave')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Akan Dipotong</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="mdi mdi-arrow-down-bold"></i></span>
                            <input type="text" id="leave_deduction" class="form-control bg-white" readonly value="- hari">
                            <span class="input-group-text">hari</span>
                        </div>
                        <div class="form-text">Sesuai durasi cuti yang diajukan</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Field HPL untuk Cuti Hamil -->
<div class="row mb-3" id="hpl_section" style="display: none;">
    <div class="col-12">
        <div class="card border-success shadow-sm">
            <div class="card-header bg-success bg-opacity-10 border-success">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-success-emphasis">
                        <i class="mdi mdi-baby-face-outline me-2"></i>Informasi Masa Kehamilan
                    </h6>
                    <span class="badge bg-success text-white">Cuti 90 Hari (3 Bulan)</span>
                </div>
            </div>
            <div class="card-body bg-success bg-opacity-5">
                <div class="alert alert-success border-0 mb-3">
                    <div class="d-flex align-items-start">
                        <i class="mdi mdi-information-outline me-2 fs-5"></i>
                        <div>
                            <strong>Cuti Hamil</strong> diberikan selama 3 bulan (90 hari) dengan perincian:
                            <div class="small mt-1">
                                <i class="mdi mdi-arrow-right-bold me-1"></i>1.5 bulan sebelum HPL (45 hari)
                            </div>
                            <div class="small">
                                <i class="mdi mdi-arrow-right-bold me-1"></i>1.5 bulan setelah HPL (45 hari)
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            HPL (Hari Perkiraan Lahir) <span class="text-danger">*</span>
                            <i class="mdi mdi-help-circle text-info ms-1" data-toggle="tooltip"
                                data-placement="right" title="Masukkan tanggal perkiraan lahir dari surat keterangan dokter/bidan"></i>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="mdi mdi-calendar-heart text-success"></i></span>
                            <input type="date" name="hpl_date" id="hpl_date"
                                class="form-control @error('hpl_date') is-invalid @enderror"
                                value="{{ old('hpl_date', $data['hpl_date'] ?? '') }}">
                        </div>
                        @error('hpl_date')
                            <div class="invalid-feedback d-block">{{ $message }}</div>
                        @enderror
                        <div class="form-text text-muted">
                            <i class="mdi mdi-lightbulb-on-outline me-1"></i>
                            Tanggal HPL minimal 45 hari ke depan. Tanggal izin akan dihitung otomatis.
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="h-100 d-flex flex-column justify-content-center">
                            <div class="alert alert-info border-0 mb-0">
                                <div class="small">
                                    <div><i class="mdi mdi-calendar-check me-2"></i><strong>Periode Cuti:</strong></div>
                                    <div class="mt-1">
                                        <span class="badge bg-light text-dark me-1">45 hari sebelum HPL</span>
                                        <span class="badge bg-light text-dark">45 hari setelah HPL</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section('scripts')
    <style>
        /* Form input enhancements */
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        }

        /* Avatar styles */
        .avatar-sm {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Gradient background for reminder card */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Alert styling */
        .alert {
            border-left: 4px solid;
            border-radius: 0.5rem;
        }

        /* Invalid feedback styling */
        .invalid-feedback {
            display: block;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Input group styling */
        .input-group-text {
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }

        /* Readonly input styling */
        .form-control[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        /* Card header styling */
        .card-header {
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* Form label styling */
        .form-label {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
    </style>
    <script>
        // Absence Settings dari Database (Master Settings)
        const absenceSettings = @json($data['absenceSettings'] ?? []);

        document.addEventListener('DOMContentLoaded', function() {
            const absenceType = document.getElementById('absence_type');
            const deadlineInfo = document.getElementById('deadline_info');
            const deadlineText = document.getElementById('deadline_text');
            const remainingLeaveSection = document.getElementById('remaining_leave_section');
            const cutiKhususCategory = document.getElementById('cuti_khusus_category');
            const cutiKhususCategorySelect = document.getElementById('cuti_khusus_category_select');
            const cutiKhususOther = document.getElementById('cuti_khusus_other');
            const cutiKhususOtherText = document.getElementById('cuti_khusus_other_text');
            const dinasPurpose = document.getElementById('dinas_purpose');
            const ijinDetail = document.getElementById('ijin_detail');
            const ijinCategory = document.getElementById('ijin_category');
            const ijinPurposeField = document.getElementById('ijin_purpose_field');
            const ijinPurpose = document.getElementById('ijin_purpose');
            const deadlineInfoField = document.getElementById('deadline_info');
            const durationDays = document.getElementById('duration_days');
            const purposeField = document.getElementById('purpose_field');
            const ijinDescription = document.getElementById('ijin_description');
            const genderField = document.querySelector('input[name="gender"]');
            const hplSection = document.getElementById('hpl_section');
            const hplDate = document.getElementById('hpl_date');
            const attachmentField = document.querySelector('input[name="attachment"]');
            const attachmentLabel = document.getElementById('attachment_label');
            const dateStart = document.getElementById('date_start');
            const dateEnd = document.getElementById('date_end');

            // Context-aware reminder system
            const reminderDynamicContent = document.getElementById('reminderDynamicContent');
            const reminderTitle = document.getElementById('reminderTitle');
            const reminderContent = document.getElementById('reminderContent');
            const reminderAllContent = document.getElementById('reminderAllContent');

            const absenceTypeReminders = {
                'DINAS': {
                    title: 'üíº Informasi Dinas',
                    content: '<ul class="mb-0"><li><strong>Deadline:</strong> H-1 (1 hari sebelum tanggal izin)</li><li>Wajib mengisi kategori dan detail tujuan dinas</li><li>Tidak mengurangi jatah cuti tahunan</li></ul>'
                },
                'CUTI TAHUNAN': {
                    title: 'üèñÔ∏è Informasi Cuti Tahunan',
                    content: '<ul class="mb-0"><li><strong>Deadline:</strong> H-7 (7 hari sebelum tanggal izin)</li><li>Akan mengurangi jatah cuti tahunan Anda</li><li>Sisa cuti akan ditampilkan di bawah</li></ul>'
                },
                'CUTI KHUSUS': {
                    title: '‚≠ê Informasi Cuti Khusus',
                    content: '<ul class="mb-0"><li>Tidak mengurangi jatah cuti tahunan</li><li>Pilih kategori yang sesuai dengan keperluan Anda</li><li>Durasi akan otomatis terisi berdasarkan kategori</li></ul>'
                },
                'CUTI HAID': {
                    title: 'üå∏ Informasi Cuti Haid',
                    content: '<ul class="mb-0"><li><strong>Deadline:</strong> Maksimal H+1 (1 hari setelah tanggal izin)</li><li>Khusus karyawan wanita</li><li>Wajib melampirkan surat dokter jika diperlukan</li></ul>'
                },
                'CUTI HAMIL': {
                    title: 'ü§∞ Informasi Cuti Hamil',
                    content: '<ul class="mb-0"><li><strong>Rentang:</strong> 1.5 bulan sebelum HPL sampai 1.5 bulan setelah HPL</li><li>Khusus karyawan wanita</li><li>Isi HPL (Hari Perkiraan Lahir) untuk mengatur tanggal otomatis</li></ul>'
                },
                'IJIN': {
                    title: 'üìã Informasi Ijin',
                    content: '<ul class="mb-0"><li>Pilihan pengajuan: <strong>Dadakan</strong> atau <strong>H-7</strong></li><li>Wajib mengisi kategori dan detail keperluan</li><li>Berlaku batasan maksimal H¬±1</li></ul>'
                },
                'SAKIT': {
                    title: 'üè• Informasi Sakit',
                    content: '<ul class="mb-0"><li>Wajib melampirkan surat dokter</li><li>Pengajuan dapat dilakukan saat sakit atau H+1 ketika masuk kerja</li><li>Isi keperluan dengan jelas</li></ul>'
                }
            };

            function updateReminder() {
                const selectedType = absenceType.value;
                if (selectedType && absenceTypeReminders[selectedType]) {
                    if (reminderDynamicContent) reminderDynamicContent.style.display = 'block';
                    if (reminderAllContent) reminderAllContent.style.display = 'none';
                    if (reminderTitle) reminderTitle.innerHTML = absenceTypeReminders[selectedType].title;
                    if (reminderContent) reminderContent.innerHTML = absenceTypeReminders[selectedType].content;
                } else {
                    if (reminderDynamicContent) reminderDynamicContent.style.display = 'none';
                    if (reminderAllContent) reminderAllContent.style.display = 'block';
                }
            }

            // Fungsi untuk update label attachment dengan tanda bintang merah jika required
            function updateAttachmentLabel() {
                if (attachmentLabel) {
                    // alert('updateAttachmentLabel');
                    if (attachmentField && attachmentField.hasAttribute('required')) {
                        // Tambahkan tanda bintang merah jika required
                        if ($('#attachment_label').length > 0) {
                            $('#attachment_label').html('Lampiran <span class="text-danger">*</span>');
                        }
                    } else {
                        // Hapus tanda bintang merah jika tidak required
                        $('#attachment_label').html('Lampiran');

                    }
                }
            }

            // Durasi otomatis untuk Cuti Khusus - dari master_sub_absence JSON
            const cutiKhususDurations = {};

            // Populate cutiKhususDurations from absenceSettings
            if (absenceSettings && absenceSettings['Cuti Khusus'] && absenceSettings['Cuti Khusus']
                .master_sub_absence) {
                absenceSettings['Cuti Khusus'].master_sub_absence.forEach(function(sub) {
                    cutiKhususDurations[sub.name] = sub.duration_days;
                });
            }

            // Filter opsi izin berdasarkan jenis kelamin
            function filterAbsenceTypeOptions() {
                const gender = genderField ? genderField.value.toLowerCase().trim() : '';
                const isFemale = gender.includes('perempuan') || gender.includes('wanita') || gender === 'p' ||
                    gender.includes('female');
                const isMale = gender.includes('laki-laki') || gender.includes('pria') || gender === 'l' ||
                    gender.includes('male');

                // Dapatkan semua opsi
                const options = absenceType.querySelectorAll('option');

                console.log(' gender: ', gender, 'options', options);

                options.forEach(option => {
                    const value = option.value;
                    // Cuti Haid dan Cuti Hamil hanya untuk wanita
                    if (value === 'CUTI HAID' || value === 'CUTI HAMIL') {
                        if (isMale || (!isFemale && gender !== '')) {
                            // Sembunyikan jika laki-laki atau gender tidak dikenali
                            option.style.display = 'none';
                            // Jika opsi yang dipilih adalah Cuti Haid atau Cuti Hamil, reset pilihan
                            if (absenceType.value === value) {
                                absenceType.value = '';
                                updateForm();
                            }
                        } else {
                            // Tampilkan jika perempuan atau gender kosong
                            option.style.display = 'block';
                        }
                    }
                });
            }

            // Panggil filter saat halaman dimuat
            filterAbsenceTypeOptions();

            function updateForm() {
                const selectedType = absenceType.value;

                console.log('tipe ', selectedType);

                // Reset semua conditional fields
                remainingLeaveSection.style.display = 'none';
                cutiKhususCategory.style.display = 'none';
                cutiKhususOther.style.display = 'none';
                dinasPurpose.style.display = 'none';
                ijinDetail.style.display = 'none';
                deadlineInfo.style.display = 'none';
                deadlineInfoField.style.display = 'none';
                hplSection.style.display = 'none';

                // Reset HPL required
                if (hplDate) {
                    hplDate.removeAttribute('required');
                }

                // Reset attachment required
                if (attachmentField) {
                    attachmentField.removeAttribute('required');
                }
                // Update label attachment
                updateAttachmentLabel();

                // Reset readonly untuk date fields (kecuali date_end yang selalu readonly)
                if (dateStart) {
                    dateStart.removeAttribute('readonly');
                }
                // dateEnd selalu readonly karena dihitung otomatis

                // Set required untuk field
                if (cutiKhususCategorySelect) {
                    cutiKhususCategorySelect.removeAttribute('required');
                }
                if (cutiKhususOtherText) {
                    cutiKhususOtherText.removeAttribute('required');
                }
                if (ijinDescription) {
                    ijinDescription.removeAttribute('required');
                }

                // Reset dinas fields
                const dinasCategory = document.getElementById('dinas_category');
                const dinasPurposeInput = document.getElementById('dinas_purpose_input');
                if (dinasCategory) {
                    dinasCategory.removeAttribute('required');
                }
                if (dinasPurposeInput) {
                    dinasPurposeInput.removeAttribute('required');
                }

                // Reset ijin fields
                if (ijinPurposeField) {
                    ijinPurposeField.style.display = 'none';
                }
                if (ijinCategory) {
                    ijinCategory.removeAttribute('required');
                }
                if (ijinPurpose) {
                    ijinPurpose.removeAttribute('required');
                }

                // Remove required dari purpose field dulu, akan di-set ulang jika diperlukan
                const purposeInput = purposeField.querySelector('input[name="purpose"]');
                if (purposeInput) {
                    purposeInput.removeAttribute('required');
                }

                // Show purpose field by default
                purposeField.style.display = 'block';

                // Set min date untuk date_start berdasarkan deadline requirement
                const today = new Date();
                let minDate = today.toISOString().split('T')[0]; // Default: hari ini

                console.log('selectedType: ', selectedType, 'absenceSettings: ', absenceSettings);
                switch (selectedType) {
                    case 'DINAS':
                        // Get deadline_text from database, fallback to default if not exists
                        const dinasDeadlineText = absenceSettings['DINAS'].deadline_text;
                        deadlineText.textContent = dinasDeadlineText;
                        deadlineInfo.style.display = 'block';
                        dinasPurpose.style.display = 'block';
                        // Set required untuk dinas_category dan dinas_purpose
                        const dinasCategory = document.getElementById('dinas_category');
                        const dinasPurposeInput = document.getElementById('dinas_purpose_input');
                        if (dinasCategory) {
                            dinasCategory.setAttribute('required', 'required');
                        }
                        if (dinasPurposeInput) {
                            dinasPurposeInput.setAttribute('required', 'required');
                        }
                        // Set required untuk attachment dari database setting
                        const dinasAttachmentRequired = absenceSettings['DINAS'].attachment_required;
                        if (attachmentField) {
                            if (dinasAttachmentRequired) {
                                attachmentField.setAttribute('required', 'required');
                            } else {
                                attachmentField.removeAttribute('required');
                            }
                        }
                        updateAttachmentLabel();
                        // Hide default purpose field untuk Dinas
                        purposeField.style.display = 'none';
                        const purposeInputDinas = purposeField.querySelector('input[name="purpose"]');
                        if (purposeInputDinas) {
                            purposeInputDinas.removeAttribute('required');
                        }
                        // Set min date dari database (min_deadline_days)
                        const dinasMinDays = absenceSettings['DINAS'].min_deadline_days;
                        const tomorrow = new Date(today);
                        tomorrow.setDate(today.getDate() + dinasMinDays);
                        minDate = tomorrow.toISOString().split('T')[0];
                        if (dateStart) {
                            dateStart.setAttribute('min', minDate);
                        }
                        break;

                    case 'CUTI TAHUNAN':
                        // Get deadline_text from database, fallback to default if not exists
                        const cutiTahunanDeadlineText = absenceSettings['CUTI TAHUNAN'].deadline_text;
                        deadlineText.textContent = cutiTahunanDeadlineText;
                        deadlineInfo.style.display = 'block';
                        remainingLeaveSection.style.display = 'block';
                        // Update leave deduction field
                        updateLeaveDeduction();

                        // Attachment required dari database
                        const cutiTahunanAttachmentRequired = absenceSettings['CUTI TAHUNAN'].attachment_required;
                        if (attachmentField && cutiTahunanAttachmentRequired) {
                            attachmentField.setAttribute('required', 'required');
                        } else if (attachmentField) {
                            attachmentField.removeAttribute('required');
                        }
                        updateAttachmentLabel();

                        // Set required untuk purpose field
                        const purposeInputCutiTahunan = purposeField.querySelector('input[name="purpose"]');
                        if (purposeInputCutiTahunan) {
                            purposeInputCutiTahunan.setAttribute('required', 'required');
                        }
                        // Set min date dari database (min_deadline_days)
                        const cutiTahunanMinDays = absenceSettings['CUTI TAHUNAN'].min_deadline_days;
                        const sevenDays = new Date(today);
                        sevenDays.setDate(today.getDate() + cutiTahunanMinDays);
                        minDate = sevenDays.toISOString().split('T')[0];
                        if (dateStart) {
                            dateStart.setAttribute('min', minDate);
                        }

                        break;

                    case 'CUTI KHUSUS':
                        // Get deadline_text from database, fallback to default if not exists
                        const cutiKhususDeadlineText = absenceSettings['CUTI KHUSUS'].deadline_text;
                        deadlineText.textContent = cutiKhususDeadlineText;
                        deadlineInfo.style.display = 'block';
                        cutiKhususCategory.style.display = 'block';
                        if (cutiKhususCategorySelect) {
                            cutiKhususCategorySelect.setAttribute('required', 'required');
                        }
                        purposeField.style.display = 'none'; // Hide default purpose field
                        // Remove required dari purpose field karena tersembunyi
                        const purposeInput = purposeField.querySelector('input[name="purpose"]');
                        if (purposeInput) {
                            purposeInput.removeAttribute('required');
                        }
                        // Attachment required dari database
                        const cutiKhususAttachmentRequired = absenceSettings['CUTI KHUSUS'].attachment_required;
                        if (attachmentField && cutiKhususAttachmentRequired) {
                            attachmentField.setAttribute('required', 'required');
                        } else if (attachmentField) {
                            attachmentField.removeAttribute('required');
                        }
                        updateAttachmentLabel();

                        $('#duration_days').prop('readonly', true); // Set readonly untuk Cuti Khusus
                        // Cuti Khusus: min date akan di-set saat kategori dipilih
                        // Default: tidak ada restriction sampai user memilih kategori
                        const cutiKhusus = absenceSettings['CUTI KHUSUS'].min_deadline_days;
                        const ckDays = new Date(today);
                        ckDays.setDate(today.getDate() + cutiKhusus);
                        minDate = ckDays.toISOString().split('T')[0];
                        if (dateStart) {
                            dateStart.setAttribute('min', minDate);
                        }
                        break;

                    case 'CUTI HAID':
                        // Get deadline_text from database, fallback to default if not exists
                        const cutiHaidDeadlineText = absenceSettings['CUTI HAID'].deadline_text;
                        deadlineText.textContent = cutiHaidDeadlineText;
                        deadlineInfo.style.display = 'block';
                        // Cuti Haid: durasi otomatis 90 hari (3 bulan)
                        // if (durationDays) {
                        //     durationDays.value = 90;
                        //     durationDays.readOnly = true; // Lock karena sudah ditentukan
                        // }
                        // Hide purpose field untuk Cuti Haid
                        purposeField.style.display = 'none';
                        const purposeInputCutiHaid = purposeField.querySelector('input[name="purpose"]');
                        if (purposeInputCutiHaid) {
                            purposeInputCutiHaid.removeAttribute('required');
                        }
                        // Attachment required dari database
                        const cutiHaidAttachmentRequired = (absenceSettings && absenceSettings['CUTI HAID'] &&
                            absenceSettings['CUTI HAID'].attachment_required);
                        if (attachmentField && cutiHaidAttachmentRequired) {
                            attachmentField.setAttribute('required', 'required');
                        } else if (attachmentField) {
                            attachmentField.removeAttribute('required');
                        }
                        updateAttachmentLabel();
                        // Tidak set min/max date di HTML, validasi dilakukan di JavaScript saja
                        // Ini memungkinkan user memilih tanggal yang sudah lewat, tapi akan divalidasi saat submit
                        const cutiHaidDays = absenceSettings['CUTI HAID'].min_deadline_days;
                        const chDays = new Date(today);
                        chDays.setDate(today.getDate() + cutiHaidDays);
                        minDate = chDays.toISOString().split('T')[0];
                        if (dateStart) {
                            dateStart.setAttribute('min', minDate);
                        }
                        break;

                    case 'CUTI HAMIL':
                        // Get deadline_text from database
                        const cutiHamilDeadlineText = absenceSettings['CUTI HAMIL'].deadline_text;
                        deadlineText.textContent = cutiHamilDeadlineText;
                        deadlineInfo.style.display = 'block';
                        hplSection.style.display = 'block';
                        if (hplDate) {
                            hplDate.setAttribute('required', 'required');
                            // Set min date untuk HPL = hari ini + 45 hari (tidak bisa dadakan)
                            const cutiHamilMinDays = absenceSettings['CUTI HAMIL'].min_deadline_days;
                            const hplMinDate = new Date(today);
                            hplMinDate.setDate(today.getDate() + cutiHamilMinDays);
                            const hplMinDateStr = hplMinDate.toISOString().split('T')[0];
                            hplDate.setAttribute('min', hplMinDateStr);

                            // Jika HPL sudah ada, langsung set tanggal awal dan akhir
                            if (hplDate.value) {
                                updateCutiHamilDateRange();
                            }
                        }
                        // Cuti Hamil: durasi otomatis 90 hari (3 bulan total)
                        if (durationDays) {
                            durationDays.value = 90;
                            durationDays.readOnly = true; // Lock karena sudah ditentukan
                        }
                        // Set readonly untuk date fields karena dihitung otomatis dari HPL
                        if (dateStart) {
                            dateStart.setAttribute('readonly', 'readonly');
                        }
                        if (dateEnd) {
                            dateEnd.setAttribute('readonly', 'readonly');
                        }
                        // Hide purpose field untuk Cuti Hamil (Keperluan tidak ada)
                        purposeField.style.display = 'none';
                        const purposeInputCutiHamil = purposeField.querySelector('input[name="purpose"]');
                        if (purposeInputCutiHamil) {
                            purposeInputCutiHamil.removeAttribute('required');
                        }
                        // Attachment required dari database
                        const cutiHamilAttachmentRequired = (absenceSettings && absenceSettings['CUTI HAMIL'] &&
                            absenceSettings['CUTI HAMIL'].attachment_required);
                        if (attachmentField && cutiHamilAttachmentRequired) {
                            attachmentField.setAttribute('required', 'required');
                        } else if (attachmentField) {
                            attachmentField.removeAttribute('required');
                        }
                        updateAttachmentLabel();
                        break;

                    case 'IJIN':
                        ijinDetail.style.display = 'block';
                        // Set required untuk Kategori Ijin
                        if (ijinCategory) {
                            ijinCategory.setAttribute('required', 'required');
                        }
                        // Tampilkan field Detail Keperluan
                        if (ijinPurposeField) {
                            ijinPurposeField.style.display = 'block';
                        }
                        // Set required untuk Detail Keperluan
                        if (ijinPurpose) {
                            ijinPurpose.setAttribute('required', 'required');
                        }
                        // Tidak perlu required untuk ijin_description karena akan dikategorikan oleh HR
                        if (ijinDescription) {
                            ijinDescription.removeAttribute('required');
                        }
                        // Hide default purpose field
                        purposeField.style.display = 'none';
                        // Remove required dari purpose field karena tersembunyi
                        const purposeInputIjin = purposeField.querySelector('input[name="purpose"]');
                        if (purposeInputIjin) {
                            purposeInputIjin.removeAttribute('required');
                        }

                        // Get deadline_text dari database
                        const ijinDeadlineText = absenceSettings['IJIN'].deadline_text;
                        deadlineText.textContent = ijinDeadlineText;
                        deadlineInfo.style.display = 'block';

                        // Ijin: min/max date dari database
                        const ijinMinDays = absenceSettings['IJIN'].min_deadline_days;
                        const ijinMaxDays = absenceSettings['IJIN'].max_deadline_days;

                        const yesterdayIjin = new Date(today);
                        yesterdayIjin.setDate(today.getDate() + parseInt(ijinMinDays));
                        const tomorrowIjin = new Date(today);
                        tomorrowIjin.setDate(today.getDate() + parseInt(ijinMaxDays));
                        if (dateStart) {
                            dateStart.setAttribute('min', yesterdayIjin.toISOString().split('T')[0]);
                            dateStart.setAttribute('max', tomorrowIjin.toISOString().split('T')[0]);
                        }

                        // Attachment required dari database
                        const ijinAttachmentRequired = absenceSettings['IJIN'].attachment_required;
                        if (attachmentField && ijinAttachmentRequired) {
                            attachmentField.setAttribute('required', 'required');
                        } else if (attachmentField) {
                            attachmentField.removeAttribute('required');
                        }
                        updateAttachmentLabel();
                        break;

                    case 'SAKIT':
                        // Get deadline_text dari database
                        const sakitDeadlineText = absenceSettings['SAKIT'].deadline_text;
                        deadlineText.textContent = sakitDeadlineText;
                        deadlineInfo.style.display = 'block';

                        // Set required untuk purpose field
                        const purposeInputSakit = purposeField.querySelector('input[name="purpose"]');
                        if (purposeInputSakit) {
                            purposeInputSakit.setAttribute('required', 'required');
                        }

                        // Attachment required dari database
                        const sakitAttachmentRequired = absenceSettings['SAKIT'].attachment_required;
                        if (attachmentField && sakitAttachmentRequired) {
                            attachmentField.setAttribute('required', 'required');
                        } else if (attachmentField) {
                            attachmentField.removeAttribute('required');
                        }
                        updateAttachmentLabel();

                        // Sakit: min/max date dari database
                        const sakitMinDays = absenceSettings['SAKIT'].min_deadline_days;
                        const smDays = new Date(today);
                        smDays.setDate(today.getDate() + sakitMinDays);
                        minDate = smDays.toISOString().split('T')[0];
                        if (dateStart) {
                            dateStart.setAttribute('min', minDate);
                        }
                        break;
                }

                // Re-validate deadline setelah update form
                if (dateStart && dateStart.value) {
                    validateDeadline();
                    // Jika Cuti Hamil, validasi juga berdasarkan HPL
                    if (selectedType === 'Cuti Hamil' && hplDate && hplDate.value) {
                        validateCutiHamilDate();
                    }
                }
            }


            // Update tanggal awal dan akhir untuk Cuti Hamil berdasarkan HPL
            function updateCutiHamilDateRange() {
                if (!dateStart || !dateEnd || !durationDays) return;

                if (!hplDate || !hplDate.value) {
                    dateStart.removeAttribute('min');
                    dateStart.removeAttribute('max');
                    dateStart.value = '';
                    dateEnd.value = '';
                    return;
                }

                const hpl = new Date(hplDate.value + 'T00:00:00');
                // Hitung 1.5 bulan = 45 hari
                const daysBefore = 45;
                const daysAfter = 45;

                // Tanggal awal = HPL - 1.5 bulan (45 hari)
                const startDate = new Date(hpl);
                startDate.setDate(hpl.getDate() - daysBefore);

                // Tanggal akhir = HPL + 1.5 bulan (45 hari)
                const endDate = new Date(hpl);
                endDate.setDate(hpl.getDate() + daysAfter);

                // Format tanggal ke YYYY-MM-DD
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                // Set tanggal awal dan akhir otomatis
                dateStart.value = formatDate(startDate);
                dateEnd.value = formatDate(endDate);

                // Set durasi = 90 hari (3 bulan total)
                durationDays.value = 90;

                // Set min dan max date untuk validasi (jika user mencoba mengubah)
                dateStart.setAttribute('min', formatDate(startDate));
                dateStart.setAttribute('max', formatDate(startDate));
                dateEnd.setAttribute('min', formatDate(endDate));
                dateEnd.setAttribute('max', formatDate(endDate));
            }

            // Validasi Cuti Hamil berdasarkan HPL
            function validateCutiHamilDate() {
                if (!hplDate || !hplDate.value || !dateStart || !dateStart.value) return;

                const hpl = new Date(hplDate.value + 'T00:00:00');
                const startDate = new Date(dateStart.value + 'T00:00:00');

                // Hitung 1.5 bulan = 45 hari
                const daysBefore = 45;
                const daysAfter = 45;

                const minDate = new Date(hpl);
                minDate.setDate(hpl.getDate() - daysBefore);
                minDate.setHours(0, 0, 0, 0);

                const maxDate = new Date(hpl);
                maxDate.setDate(hpl.getDate() + daysAfter);
                maxDate.setHours(23, 59, 59, 999);

                startDate.setHours(0, 0, 0, 0);

                if (startDate < minDate || startDate > maxDate) {
                    const minDateStr = minDate.toLocaleDateString('id-ID', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    const maxDateStr = maxDate.toLocaleDateString('id-ID', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });

                    dateStart.setCustomValidity(
                        `Tanggal izin harus dalam rentang 1.5 bulan sebelum HPL sampai 1.5 bulan setelah HPL (${minDateStr} - ${maxDateStr})`
                    );
                    dateStart.classList.add('is-invalid');

                    let errorDiv = dateStart.parentElement.querySelector('.hpl-error');
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback hpl-error';
                        dateStart.parentElement.appendChild(errorDiv);
                    }
                    errorDiv.textContent =
                        `Tanggal izin harus dalam rentang 1.5 bulan sebelum HPL sampai 1.5 bulan setelah HPL (${minDateStr} - ${maxDateStr})`;
                } else {
                    dateStart.setCustomValidity('');
                    dateStart.classList.remove('is-invalid');

                    const errorDiv = dateStart.parentElement.querySelector('.hpl-error');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                }
            }

            // Event listener untuk HPL date change
            if (hplDate) {
                hplDate.addEventListener('change', function() {
                    if (absenceType.value === 'CUTI HAMIL') {
                        // Validasi HPL minimal 45 hari ke depan
                        const hplMinDays = absenceSettings['CUTI HAMIL'].min_deadline_days;
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const hplSelected = new Date(hplDate.value + 'T00:00:00');
                        hplSelected.setHours(0, 0, 0, 0);

                        const minAllowedDate = new Date(today);
                        minAllowedDate.setDate(today.getDate() + hplMinDays);

                        if (hplSelected < minAllowedDate) {
                            const minDateStr = minAllowedDate.toLocaleDateString('id-ID', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                            hplDate.setCustomValidity(`HPL minimal ${hplMinDays} hari ke depan (${minDateStr})`);
                            hplDate.classList.add('is-invalid');

                            let errorDiv = hplDate.parentElement.querySelector('.hpl-min-error');
                            if (!errorDiv) {
                                errorDiv = document.createElement('div');
                                errorDiv.className = 'invalid-feedback hpl-min-error';
                                hplDate.parentElement.appendChild(errorDiv);
                            }
                            errorDiv.textContent = `HPL minimal ${hplMinDays} hari ke depan (${minDateStr})`;
                        } else {
                            hplDate.setCustomValidity('');
                            hplDate.classList.remove('is-invalid');

                            const errorDiv = hplDate.parentElement.querySelector('.hpl-min-error');
                            if (errorDiv) {
                                errorDiv.remove();
                            }

                            // Jika valid, baru update tanggal cuti
                            updateCutiHamilDateRange();
                        }
                    }
                });
            }

            // Remove duplicate "Lainnya" option in Cuti Khusus category
            if (cutiKhususCategorySelect) {
                const lainnyaOptions = Array.from(cutiKhususCategorySelect.options).filter(
                    option => option.value === 'Lainnya'
                );
                // Keep only the first "Lainnya" option, remove the rest
                if (lainnyaOptions.length > 1) {
                    for (let i = 1; i < lainnyaOptions.length; i++) {
                        lainnyaOptions[i].remove();
                    }
                }

                cutiKhususCategorySelect.addEventListener('change', function() {
                    const category = this.value;
                    const selectedType = absenceType.value;

                    // Hanya proses jika yang dipilih adalah CUTI KHUSUS
                    if (selectedType !== 'CUTI KHUSUS') return;

                    if (category === 'Lainnya') {
                        if (cutiKhususOther) {
                            cutiKhususOther.style.display = 'block';
                        }
                        if (cutiKhususOtherText) {
                            cutiKhususOtherText.setAttribute('required', 'required');
                        }
                        if (durationDays) {
                            durationDays.value = '';
                            durationDays.readOnly = false;
                        }
                        // Untuk "Lainnya", tidak ada min date restriction
                        if (dateStart) {
                            dateStart.removeAttribute('min');
                            dateStart.removeAttribute('max');
                        }
                    } else {
                        if (cutiKhususOther) {
                            cutiKhususOther.style.display = 'none';
                        }
                        if (cutiKhususOtherText) {
                            cutiKhususOtherText.removeAttribute('required');
                        }

                        console.log('absenceSettings CUTI KHUSUS: ', absenceSettings['CUTI KHUSUS']);

                        // Set tanggal awal otomatis sesuai minimum_days dari master
                        // Cari minimum_days dari master_sub_absence
                        // Handle jika master_sub_absence adalah object atau array
                        const masterSubAbsence = absenceSettings['CUTI KHUSUS'].master_sub_absence;
                        const subAbsenceArray = Array.isArray(masterSubAbsence) ? masterSubAbsence : Object.values(masterSubAbsence || {});
                        const categoryData = subAbsenceArray.find(
                            sub => sub.name === category
                        );

                        const minimumDays = categoryData.duration_days;
                        $('#duration_days').val(minimumDays);

                        if (dateStart && minimumDays !== undefined && minimumDays !== null) {
                            const today = new Date();
                            const startDate = new Date(today);
                            startDate.setDate(today.getDate() + parseInt(minimumDays));
                            const startDateStr = startDate.toISOString().split('T')[0];
                            // Set tanggal awal otomatis
                            dateStart.value = startDateStr;
                            // Trigger calculateDateEnd untuk update date_end
                            calculateDateEnd();
                        }

                        // Re-validate deadline setelah ganti kategori
                        if (dateStart && dateStart.value) {
                            validateDeadline();
                        }
                    }
                });
            }

            // Auto-calculate date_end based on date_start and duration_days
            function calculateDateEnd() {
                // Jangan hitung untuk Cuti Hamil karena tanggal dihitung otomatis dari HPL
                if (absenceType && absenceType.value === 'Cuti Hamil') {
                    return;
                }

                if (dateStart && dateEnd && dateStart.value && durationDays && durationDays.value) {
                    const startDate = new Date(dateStart.value);
                    const duration = parseInt(durationDays.value) || 1;
                    const endDate = new Date(startDate);

                    // Untuk semua jenis: Tanggal Awal + Selama - 1 (karena tanggal awal sudah termasuk)
                    endDate.setDate(startDate.getDate() + duration - 1);

                    // Format as YYYY-MM-DD
                    const year = endDate.getFullYear();
                    const month = String(endDate.getMonth() + 1).padStart(2, '0');
                    const day = String(endDate.getDate()).padStart(2, '0');
                    dateEnd.value = `${year}-${month}-${day}`;
                }
            }

            // Update leave deduction field untuk Cuti Tahunan
            function updateLeaveDeduction() {
                const leaveDeductionField = document.getElementById('leave_deduction');
                if (!leaveDeductionField) return;

                if (durationDays && durationDays.value) {
                    const duration = parseInt(durationDays.value) || 0;
                    leaveDeductionField.value = `${duration} hari`;
                } else {
                    leaveDeductionField.value = '- hari';
                }
            }

            // Calculate date_end when date_start or duration_days changes
            if (dateStart) {
                dateStart.addEventListener('change', calculateDateEnd);
            }
            if (durationDays) {
                durationDays.addEventListener('change', function() {
                    // Pastikan durasi Cuti Hamil selalu 90 hari (3 bulan)
                    if (absenceType && absenceType.value === 'Cuti Hamil') {
                        if (durationDays.value !== '90') {
                            durationDays.value = 90;
                        }
                    }
                    // Pastikan durasi Cuti Haid selalu 90 hari (3 bulan)
                    if (absenceType && absenceType.value === 'Cuti Haid') {
                        if (durationDays.value !== '90') {
                            durationDays.value = 90;
                        }
                    }
                    calculateDateEnd();
                    updateLeaveDeduction();
                });
            }

            // Validate deadline saat date_start diubah
            if (dateStart) {
                dateStart.addEventListener('change', function() {
                    validateDeadline();
                    // Jika Cuti Hamil, validasi juga berdasarkan HPL
                    if (absenceType && absenceType.value === 'Cuti Hamil' && hplDate && hplDate.value) {
                        validateCutiHamilDate();
                    }
                });
            }

            function validateDeadline() {
                if (!dateStart || !dateStart.value || !absenceType || !absenceType.value) return;

                const selectedType = absenceType.value;

                // Cuti Hamil hanya menggunakan validasi HPL, tidak ada validasi deadline H-7
                if (selectedType === 'Cuti Hamil') {
                    validateCutiHamilDate();
                    return;
                }

                const startDate = new Date(dateStart.value + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Calculate difference in days (date_start - today)
                // Positive = date_start is in the future, negative = date_start is in the past
                const diffTime = startDate.getTime() - today.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                let minDays = 0;
                let maxDays = null;
                let deadlineType = '';
                let errorMessage = '';

                // Get deadline settings from database
                if (absenceSettings && absenceSettings[selectedType]) {
                    console.log('masuk sini ', selectedType, absenceSettings[selectedType]);
                    const settings = absenceSettings[selectedType];

                    // Khusus untuk Cuti Khusus: gunakan duration_days sebagai min_deadline_days (tidak bisa backdate)
                    if (selectedType === 'CUTI KHUSUS') {
                        const selectedCategory = cutiKhususCategorySelect ? cutiKhususCategorySelect.value : null;
                        if (selectedCategory && selectedCategory !== 'Lainnya' && cutiKhususDurations[
                                selectedCategory] !== undefined && cutiKhususDurations[selectedCategory] !== null) {
                            minDays = parseInt(cutiKhususDurations[selectedCategory]);
                            deadlineType = minDays >= 0 ? 'H+' + minDays : 'H' + minDays;
                        }
                        // Jika "Lainnya" atau tidak ada duration_days, gunakan default dari parent
                        else if (settings.min_deadline_days !== null && settings.min_deadline_days !== undefined) {
                            minDays = settings.min_deadline_days;
                            deadlineType = minDays >= 0 ? 'H+' + minDays : 'H' + minDays;
                        }
                    } else {

                        console.log('selain masuk sini');
                        // Set min_deadline_days from database untuk jenis lain
                        if (settings.min_deadline_days !== null && settings.min_deadline_days !== undefined) {
                            minDays = settings.min_deadline_days;
                            // Format deadline type (H+7, H-1, etc)
                            deadlineType = minDays >= 0 ? 'H+' + minDays : 'H' + minDays;
                        }
                    }

                    // Set max_deadline_days from database
                    if (settings.max_deadline_days !== null && settings.max_deadline_days !== undefined) {
                        maxDays = settings.max_deadline_days;
                    }
                } else {
                    console.log('gunakan hardcoded ', selectedType);
                    // Fallback to hardcoded values if not in database
                    switch (selectedType) {
                        case 'DINAS':
                            minDays = 1;
                            deadlineType = 'H-1';
                            break;
                        case 'CUTI TAHUNAN':
                            minDays = 7;
                            deadlineType = 'H-7';
                            break;
                        case 'CUTI HAID':
                            maxDays = 1;
                            deadlineType = 'H+1';
                            break;
                        case 'IJIN':
                            maxDays = 1;
                            minDays = -1;
                            break;
                        case 'SAKIT':
                            maxDays = 1;
                            break;
                    }
                }

                // Validasi untuk deadline maximum
                // if (maxDays !== null && diffDays > maxDays) {
                //     const maxAllowedDate = new Date(today);
                //     maxAllowedDate.setDate(today.getDate() + maxDays);
                //     const maxDateStr = maxAllowedDate.toLocaleDateString('id-ID', {
                //         day: '2-digit',
                //         month: '2-digit',
                //         year: 'numeric'
                //     });
                //     const maxDeadlineType = maxDays >= 0 ? 'H+' + maxDays : 'H' + maxDays;
                //     errorMessage =
                //         `Pengajuan ${selectedType} maksimal ${maxDeadlineType} (${maxDays} hari setelah tanggal izin). Tanggal izin maksimal ${maxDateStr}`;
                // }

                // Validasi untuk deadline minimum (bisa negatif untuk H-1)
                if (minDays !== 0 && diffDays < minDays) {
                    // Calculate minimum allowed date
                    const minDate = new Date(today);
                    minDate.setDate(today.getDate() + minDays);
                    const minDateStr = minDate.toLocaleDateString('id-ID', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });

                    // For positive minDays (H+7), use "minimal" text
                    // For negative minDays (H-1), use "maksimal" text because it's in the past
                    if (minDays > 0) {
                        errorMessage =
                            `Pengajuan ${selectedType} harus minimal ${deadlineType} (${minDays} hari sebelum tanggal izin). Tanggal izin minimal ${minDateStr}`;
                    } else if (minDays < 0) {
                        errorMessage =
                            `Pengajuan ${selectedType} harus dilakukan maksimal ${deadlineType} (${Math.abs(minDays)} hari sebelum tanggal izin). Tanggal izin minimal ${minDateStr}`;
                    }
                }

                // Tampilkan error jika ada
                if (errorMessage) {
                    dateStart.setCustomValidity(errorMessage);
                    dateStart.classList.add('is-invalid');

                    // Show error message
                    let errorDiv = dateStart.parentElement.querySelector('.deadline-error');
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback deadline-error';
                        dateStart.parentElement.appendChild(errorDiv);
                    }
                    errorDiv.textContent = errorMessage;
                } else {
                    dateStart.setCustomValidity('');
                    dateStart.classList.remove('is-invalid');

                    // Remove error message
                    const errorDiv = dateStart.parentElement.querySelector('.deadline-error');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                }
            }


            // Main event listener
            if (absenceType) {
                absenceType.addEventListener('change', function() {
                    updateForm();
                    updateReminder(); // Update context-aware reminder
                    // Validate deadline setelah update form
                    if (dateStart && dateStart.value) {
                        validateDeadline();
                    }
                });
            }

            // Initial call
            updateForm();
            updateReminder(); // Initialize context-aware reminder
            // Update label attachment setelah initial form update
            updateAttachmentLabel();

            // Validate deadline saat absence_type sudah terisi dan date_start sudah ada
            if (absenceType && absenceType.value && dateStart && dateStart.value) {
                validateDeadline();
            }

            // Filter opsi saat jenis kelamin berubah (jika field bisa diubah)
            if (genderField) {
                // Catat: field gender adalah readonly, tapi kita filter saat load
                // Jika nanti field gender bisa diubah, uncomment baris berikut:
                // genderField.addEventListener('change', function() {
                //     filterAbsenceTypeOptions();
                //     if (absenceType.value === 'Cuti Haid' || absenceType.value === 'Cuti Hamil') {
                //         absenceType.value = '';
                //         updateForm();
                //     }
                // });
            }

            const absenceFormElement = document.querySelector('form[action="{{ route('hr.requests.store') }}"]');

            // Function to get fresh CSRF token
            const getCsrfToken = () => {
                const metaTag = document.querySelector('meta[name="csrf-token"]');
                return metaTag ? metaTag.getAttribute('content') : '';
            };

            if (absenceFormElement) {
                const requestTypeInput = absenceFormElement.querySelector('input[name="request_type"]');

                if (requestTypeInput && requestTypeInput.value === 'absence') {
                    const submitButton = absenceFormElement.querySelector('button[type="submit"]');
                    const originalButtonHtml = submitButton ? submitButton.innerHTML : '';

                    const resetSubmitButton = () => {
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalButtonHtml;
                        }
                    };

                    const showValidationErrors = (errors) => {
                        const messages = [];
                        Object.values(errors || {}).forEach((msgs) => {
                            messages.push(...msgs);
                        });

                        if (messages.length) {
                            Swal.fire({
                                title: 'Validasi Error',
                                html: messages.join('<br>'),
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    };

                    const submitAbsenceWithConfirmation = () => {
                        const confirmData = new FormData(absenceFormElement);

                        // Get fresh CSRF token before submitting
                        const freshCsrfToken = getCsrfToken();

                        if (submitButton) {
                            submitButton.disabled = true;
                            submitButton.innerHTML =
                                '<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...';
                        }

                        fetch('{{ route('hr.requests.store.confirm') }}', {
                                method: 'POST',
                                headers: {
                                    'X-CSRF-TOKEN': freshCsrfToken,
                                    'Accept': 'application/json'
                                },
                                body: confirmData
                            })
                            .then(async (response) => {
                                if (response.ok) {
                                    return response.json();
                                }

                                // Handle 419 CSRF token mismatch
                                if (response.status === 419) {
                                    const data = await response.json().catch(() => ({}));
                                    Swal.fire({
                                        icon: 'warning',
                                        title: 'Session Expired',
                                        text: data.message || 'CSRF token tidak valid. Silakan refresh halaman dan coba lagi.',
                                        confirmButtonText: 'Refresh Halaman',
                                        allowOutsideClick: false
                                    }).then(() => {
                                        window.location.reload();
                                    });
                                    throw new Error('csrf-mismatch');
                                }

                                if (response.status === 422) {
                                    const data = await response.json();
                                    showValidationErrors(data.errors || {});
                                    throw new Error('validation');
                                }

                                const data = await response.json().catch(() => ({}));
                                const message = data.message ||
                                    'Terjadi kesalahan saat menyimpan data.';
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: message,
                                    confirmButtonText: 'OK'
                                });
                                throw new Error('request-failed');
                            })
                            .then((data) => {
                                if (data.success) {
                                    Swal.fire({
                                        title: 'Berhasil!',
                                        text: data.message || 'Pengajuan berhasil dibuat',
                                        icon: 'success',
                                        confirmButtonText: 'OK',
                                        timer: 3000,
                                        timerProgressBar: true
                                    }).then(() => {
                                        if (data.redirect) {
                                            window.location.href = data.redirect;
                                        } else {
                                            window.location.href = '{{ route('hr.requests.index') }}';
                                        }
                                    });
                                } else {
                                    const message = data.message ||
                                        'Terjadi kesalahan saat menyimpan data.';

                                    // Check if there are validation errors
                                    if (data.errors) {
                                        showValidationErrors(data.errors);
                                    } else {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Error',
                                            text: message,
                                            confirmButtonText: 'OK'
                                        });
                                    }
                                    resetSubmitButton();
                                }
                            })
                            .catch((error) => {
                                if (error.message !== 'validation' && error.message !== 'request-failed' && error.message !== 'csrf-mismatch') {
                                    console.error('Error submitting form with confirmation:', error);
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'Terjadi kesalahan saat menyimpan data. Silakan coba lagi atau hubungi administrator.',
                                        confirmButtonText: 'OK'
                                    });
                                }

                                if (error.message !== 'csrf-mismatch') {
                                    resetSubmitButton();
                                }
                            })
                            .finally(() => {
                                resetSubmitButton();
                            });
                    };

                    absenceFormElement.addEventListener('submit', function(event) {
                        event.preventDefault();

                        if (!submitButton) {
                            absenceFormElement.submit();
                            return;
                        }

                        submitButton.disabled = true;
                        submitButton.innerHTML =
                            '<span class="spinner-border spinner-border-sm me-2"></span>Mengecek...';

                        const formData = new FormData(absenceFormElement);

                        // Get fresh CSRF token before submitting
                        const freshCsrfToken = getCsrfToken();

                        fetch(absenceFormElement.action, {
                                method: 'POST',
                                headers: {
                                    'X-CSRF-TOKEN': freshCsrfToken,
                                    'Accept': 'application/json'
                                },
                                body: formData
                            })
                            .then(async (response) => {
                                if (response.ok) {
                                    return response.json();
                                }

                                // Handle 419 CSRF token mismatch
                                if (response.status === 419) {
                                    const data = await response.json().catch(() => ({}));
                                    Swal.fire({
                                        icon: 'warning',
                                        title: 'Session Expired',
                                        text: data.message || 'CSRF token tidak valid. Silakan refresh halaman dan coba lagi.',
                                        confirmButtonText: 'Refresh Halaman',
                                        allowOutsideClick: false
                                    }).then(() => {
                                        window.location.reload();
                                    });
                                    throw new Error('csrf-mismatch');
                                }

                                if (response.status === 422) {
                                    const data = await response.json();
                                    showValidationErrors(data.errors || {});
                                    throw new Error('validation');
                                }

                                const data = await response.json().catch(() => ({}));
                                const message = data.message ||
                                    'Terjadi kesalahan saat mengirim data.';
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: message,
                                    confirmButtonText: 'OK'
                                });
                                throw new Error('request-failed');
                            })
                            .then((data) => {
                                if (data.is_holiday) {
                                    const holidayList = (data.holiday_dates || []).map((item) => {
                                        const dateLabel = item.date_label || item.date;
                                        const name = item.holiday_name ?
                                            ` (${item.holiday_name})` : '';
                                        return `${dateLabel}${name}`;
                                    }).join('<br>');

                                    const messageHtml = data.message ||
                                        'Tanggal yang dipilih termasuk hari libur.';

                                    Swal.fire({
                                        title: 'Konfirmasi Tanggal',
                                        html: holidayList ?
                                            `${messageHtml}<br><br>${holidayList}` :
                                            messageHtml,
                                        icon: 'warning',
                                        showCancelButton: true,
                                        confirmButtonColor: '#3085d6',
                                        cancelButtonColor: '#d33',
                                        confirmButtonText: 'Ya, Lanjutkan',
                                        cancelButtonText: 'Batal',
                                        reverseButtons: true
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            submitAbsenceWithConfirmation();
                                        } else {
                                            resetSubmitButton();
                                        }
                                    });
                                } else if (data.success) {
                                    Swal.fire({
                                        title: 'Berhasil!',
                                        text: data.message || 'Pengajuan berhasil dibuat',
                                        icon: 'success',
                                        confirmButtonText: 'OK',
                                        timer: 3000,
                                        timerProgressBar: true
                                    }).then(() => {
                                        if (data.redirect) {
                                            window.location.href = data.redirect;
                                        } else {
                                            window.location.href = '{{ route('hr.requests.index') }}';
                                        }
                                    });
                                } else {
                                    const message = data.message ||
                                        'Terjadi kesalahan saat mengirim data.';

                                    // Check if there are validation errors
                                    if (data.errors) {
                                        showValidationErrors(data.errors);
                                    } else {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Error',
                                            text: message,
                                            confirmButtonText: 'OK'
                                        });
                                    }
                                    resetSubmitButton();
                                }
                            })
                            .catch((error) => {
                                if (error.message !== 'validation' && error.message !==
                                    'request-failed' && error.message !== 'csrf-mismatch') {
                                    console.error('Error submitting form:', error);
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'Terjadi kesalahan saat mengirim data. Silakan coba lagi atau hubungi administrator.',
                                        confirmButtonText: 'OK'
                                    });
                                }

                                if (error.message !== 'csrf-mismatch') {
                                    resetSubmitButton();
                                }
                            });
                    });
                }
            }
        });
    </script>
@endsection
