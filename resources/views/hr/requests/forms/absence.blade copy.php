<!-- Form Permohonan Tidak Masuk Kerja -->
<!-- Reminder Accordion -->
<div class="row mb-3">
    <div class="col-12">
        <div class="accordion" id="reminderAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="reminderHeading">
                    <button class="btn btn-info accordion-button collapsed" style="width: 100%;" type="button" data-toggle="collapse"
                        data-target="#reminderCollapse" aria-expanded="false" aria-controls="reminderCollapse">
                        <i class="mdi mdi-information-outline me-2"></i>
                        <strong>Reminder & Informasi Penting Perizinan</strong>
                    </button>
                </h2>
                <div id="reminderCollapse" class="accordion-collapse collapse" aria-labelledby="reminderHeading"
                    data-parent="#reminderAccordion">
                    <div class="accordion-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <strong><i class="mdi mdi-airplane me-2"></i>Dinas</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li><strong>Deadline:</strong> H-1 (1 hari sebelum tanggal izin)</li>
                                            <li>Wajib mengisi Tujuan Dinas</li>
                                            <li>Tidak mengurangi jatah cuti tahunan</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <strong><i class="mdi mdi-calendar-check me-2"></i>Cuti Tahunan</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li><strong>Deadline:</strong> H-7 (7 hari sebelum tanggal izin)</li>
                                            <li>Mengurangi jatah cuti tahunan</li>
                                            <li>Sisa cuti akan divalidasi saat pengajuan</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <strong><i class="mdi mdi-star-circle me-2"></i>Cuti Khusus</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li>Tidak mengurangi jatah cuti tahunan</li>
                                            <li><strong>Kategori tersedia:</strong>
                                                <ul class="mt-2 mb-0">
                                                    <li>Pernikahan Karyawan (3 hari)</li>
                                                    <li>Mengkhitankan/Membaptis Anak (2 hari)</li>
                                                    <li>Pernikahan Anak Karyawan (2 hari)</li>
                                                    <li>Kematian Keluarga (1-2 hari sesuai kategori)</li>
                                                    <li>Persalinan Istri/Keguguran (2 hari)</li>
                                                    <li>Lainnya (isi keterangan sendiri)</li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <strong><i class="mdi mdi-heart-pulse me-2"></i>Cuti Haid</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li><strong>Deadline:</strong> Maksimal H+1 (1 hari setelah tanggal izin)</li>
                                            <li>Khusus karyawan wanita</li>
                                            <li>Wajib melampirkan surat dokter</li>
                                            <li>Tidak mengurangi jatah cuti tahunan</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <strong><i class="mdi mdi-baby-face-outline me-2"></i>Cuti Hamil</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li><strong>Rentang:</strong> 1.5 bulan sebelum HPL sampai 1.5 bulan setelah HPL</li>
                                            <li>Khusus karyawan wanita</li>
                                            <li>Wajib mengisi HPL (Hari Perkiraan Lahir)</li>
                                            <li>Tidak mengurangi jatah cuti tahunan</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-secondary">
                                    <div class="card-header bg-secondary text-white">
                                        <strong><i class="mdi mdi-account-check me-2"></i>Ijin</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li>Pilihan pengajuan: <strong>Dadakan</strong> atau <strong>H-7</strong></li>
                                            <li>Wajib mengisi keterangan izin secara detail</li>
                                            <li>Maksimal H+1 atau H-1</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-dark">
                                    <div class="card-header bg-dark text-white">
                                        <strong><i class="mdi mdi-hospital-box me-2"></i>Sakit</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li>Wajib melampirkan surat dokter</li>
                                            <li>Pengajuan dapat dilakukan saat sakit atau H+1 ketika masuk kerja</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="mdi mdi-alert-circle-outline me-2"></i>
                            <strong>Catatan Penting:</strong> Pastikan untuk mengajukan izin sesuai dengan deadline yang ditentukan. Pengajuan yang terlambat akan ditolak oleh sistem.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <h5 class="text-primary">Data Pemohon</h5>
        <hr>
    </div>
</div>

<div class="row mb-3">
    <label class="form-label col-md-2">Nama <span class="text-danger">*</span></label>
    <div class="col-md-4">
        <input type="text" name="name" class="form-control @error('name') is-invalid @enderror"
            value="{{ old('name', $data['name'] ?? auth()->user()->name) }}" required readonly>
        @error('name')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
    </div>
    <br>
</div>
<div class="row mb-3">
    <label class="form-label col-md-2">Jenis Kelamin</label>
    <div class="col-md-4">
        <input type="text" name="gender" class="form-control"
            value="{{ old('gender', $data['employee_gender'] ?? '') }}" required readonly>
    </div>
</div>
<div class="row mb-3">
    <label class="form-label col-md-2">Bagian <span class="text-danger">*</span></label>
    <div class="col-md-4">
        <input type="text" name="department" class="form-control @error('department') is-invalid @enderror"
            value="{{ old('department', $data['department'] ?? (auth()->user()->divisiUser->divisi ?? '')) }}" required readonly>
        @error('department')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
    </div>
</div>

<div class="row mb-3">
    <label class="form-label col-md-2">Mengajukan Izin <span class="text-danger">*</span></label>
    <div class="col-md-4">
        <select name="absence_type" id="absence_type" class="form-select form-control @error('absence_type') is-invalid @enderror"
            required>
            <option value="">Pilih Jenis Izin</option>
            <option value="Dinas" {{ old('absence_type') == 'Dinas' ? 'selected' : '' }}>Dinas</option>
            <option value="Cuti Tahunan" {{ old('absence_type') == 'Cuti Tahunan' ? 'selected' : '' }}>Cuti Tahunan</option>
            <option value="Cuti Khusus" {{ old('absence_type') == 'Cuti Khusus' ? 'selected' : '' }}>Cuti Khusus</option>
            <option value="Cuti Haid" {{ old('absence_type') == 'Cuti Haid' ? 'selected' : '' }}>Cuti Haid</option>
            <option value="Cuti Hamil" {{ old('absence_type') == 'Cuti Hamil' ? 'selected' : '' }}>Cuti Hamil</option>
            <option value="Ijin" {{ old('absence_type') == 'Ijin' ? 'selected' : '' }}>Ijin</option>
            <option value="Sakit" {{ old('absence_type') == 'Sakit' ? 'selected' : '' }}>Sakit</option>
        </select>
        @error('absence_type')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
        <!-- Info Deadline -->
        <div id="deadline_info" class="mt-2" style="display: none;">
            <small class="text-info"><i class="mdi mdi-information"></i> <span id="deadline_text"></span></small>
        </div>
    </div>
    <div class="col-md-6">
    <div class="row" id="cuti_khusus_category" style="display: none;">
        <label class="form-label col-md-4">Kategori Cuti Khusus <span class="text-danger">*</span></label>
        <div class="col-md-8">
            <select name="cuti_khusus_category" id="cuti_khusus_category_select" class="form-select form-control">
                <option value="">Pilih Kategori</option>
                <option value="Pernikahan Karyawan" {{ old('cuti_khusus_category') == 'Pernikahan Karyawan' ? 'selected' : '' }}>Pernikahan Karyawan (3 hari)</option>
                <option value="Mengkhitankan/Membaptis Anak" {{ old('cuti_khusus_category') == 'Mengkhitankan/Membaptis Anak' ? 'selected' : '' }}>Mengkhitankan/Membaptis Anak (2 hari)</option>
                <option value="Pernikahan Anak Karyawan" {{ old('cuti_khusus_category') == 'Pernikahan Anak Karyawan' ? 'selected' : '' }}>Pernikahan Anak Karyawan (2 hari)</option>
                <option value="Kematian Anak/Suami/Istri" {{ old('cuti_khusus_category') == 'Kematian Anak/Suami/Istri' ? 'selected' : '' }}>Kematian Anak/Suami/Istri (2 hari)</option>
                <option value="Kematian Ayah/Ibu/Mertua/Menantu" {{ old('cuti_khusus_category') == 'Kematian Ayah/Ibu/Mertua/Menantu' ? 'selected' : '' }}>Kematian Ayah/Ibu/Mertua/Menantu (2 hari)</option>
                <option value="Kematian Orang Serumah" {{ old('cuti_khusus_category') == 'Kematian Orang Serumah' ? 'selected' : '' }}>Kematian Orang Serumah (1 hari)</option>
                <option value="Persalinan Istri/Keguguran" {{ old('cuti_khusus_category') == 'Persalinan Istri/Keguguran' ? 'selected' : '' }}>Persalinan Istri/Keguguran (2 hari)</option>
                <option value="Lainnya" {{ old('cuti_khusus_category') == 'Lainnya' ? 'selected' : '' }}>Lainnya</option>
            </select>
        </div>
        <div class="col-md-6" id="cuti_khusus_other" style="display: none;">
            <label class="form-label">Keterangan Cuti Khusus <span class="text-danger">*</span></label>
            <input type="text" name="cuti_khusus_other_text" id="cuti_khusus_other_text" class="form-control"
                value="{{ old('cuti_khusus_other_text', '') }}" placeholder="Isi keterangan cuti khusus">
        </div>
    </div>
    </div>
</div>

<div class="row mb-3">
    <label class="form-label col-md-2">Selama <span class="text-danger">*</span></label>
    <div class="col-md-4">
        <div class="input-group">
            <input type="number" name="duration_days" id="duration_days" class="form-control @error('duration_days') is-invalid @enderror"
                value="{{ old('duration_days', $data['duration_days'] ?? '') }}" min="1" required>
            <span class="input-group-text">hari</span>
        </div>
        @error('duration_days')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
    </div>
</div>
<hr>

<!-- Sub-kategori Cuti Khusus (muncul jika Cuti Khusus dipilih) -->


<!-- Field Dinas (muncul jika Dinas dipilih) -->
<div class="row mb-3" id="dinas_purpose" style="display: none;">
    <div class="col-md-6 mb-3">
        <label class="form-label">Kategori Keperluan <span class="text-danger">*</span></label>
        <select name="dinas_category" id="dinas_category" class="form-select form-control @error('dinas_category') is-invalid @enderror" required>
            <option value="">Pilih Kategori</option>
            <option value="VISIT JAKARTA" {{ old('dinas_category') == 'VISIT JAKARTA' ? 'selected' : '' }}>VISIT JAKARTA</option>
            <option value="JAWA TENGAH" {{ old('dinas_category') == 'JAWA TENGAH' ? 'selected' : '' }}>JAWA TENGAH</option>
            <option value="BALI" {{ old('dinas_category') == 'BALI' ? 'selected' : '' }}>BALI</option>
            <option value="DEMO" {{ old('dinas_category') == 'DEMO' ? 'selected' : '' }}>DEMO</option>
            <option value="TRAINING" {{ old('dinas_category') == 'TRAINING' ? 'selected' : '' }}>TRAINING</option>
            <option value="JOB FAIR" {{ old('dinas_category') == 'JOB FAIR' ? 'selected' : '' }}>JOB FAIR</option>
            <option value="SEMINAR" {{ old('dinas_category') == 'SEMINAR' ? 'selected' : '' }}>SEMINAR</option>
            <option value="PSIKOTES" {{ old('dinas_category') == 'PSIKOTES' ? 'selected' : '' }}>PSIKOTES</option>
            <option value="WORKSHOP" {{ old('dinas_category') == 'WORKSHOP' ? 'selected' : '' }}>WORKSHOP</option>
        </select>
        @error('dinas_category')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
    </div>
    <div class="col-md-6 mb-3">
        <label class="form-label">Catatan Tambahan / Detail Tujuan <span class="text-danger">*</span></label>
        <textarea name="dinas_purpose" id="dinas_purpose_input" class="form-control @error('dinas_purpose') is-invalid @enderror"
            rows="3" placeholder="Isi keterangan kemana keperluan tersebut" required>{{ old('dinas_purpose', '') }}</textarea>
        @error('dinas_purpose')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
        <small class="text-muted">Ganti detail tujuan, diisi keterangan diisikan kemana keperluan tersebut</small>
    </div>
</div>

<!-- Field Ijin (muncul jika Ijin dipilih) -->
<div class="row mb-3" id="ijin_detail" style="display: none;">
    <div class="col-md-6 mb-3">
        <label class="form-label">Kategori Ijin <span class="text-danger">*</span></label>
        <select name="ijin_category" id="ijin_category" class="form-select form-control @error('ijin_category') is-invalid @enderror" required>
            <option value="">Pilih Kategori</option>
            <option value="KEMATIAN" {{ old('ijin_category') == 'KEMATIAN' ? 'selected' : '' }}>KEMATIAN</option>
            <option value="ACARA KELUARGA" {{ old('ijin_category') == 'ACARA KELUARGA' ? 'selected' : '' }}>ACARA KELUARGA</option>
            <option value="PERNIKAHAN" {{ old('ijin_category') == 'PERNIKAHAN' ? 'selected' : '' }}>PERNIKAHAN</option>
            <option value="KEPENTINGAN PRIBADI" {{ old('ijin_category') == 'KEPENTINGAN PRIBADI' ? 'selected' : '' }}>KEPENTINGAN PRIBADI</option>
            <option value="KELAHIRAN" {{ old('ijin_category') == 'KELAHIRAN' ? 'selected' : '' }}>KELAHIRAN</option>
            <option value="KELUARGA SAKIT" {{ old('ijin_category') == 'KELUARGA SAKIT' ? 'selected' : '' }}>KELUARGA SAKIT</option>
        </select>
        @error('ijin_category')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
    </div>
    <div class="col-md-6 mb-3" id="ijin_purpose_field" style="display: none;">
        <label class="form-label">Detail Keperluan <span class="text-danger">*</span></label>
        <textarea name="ijin_purpose" id="ijin_purpose" class="form-control @error('ijin_purpose') is-invalid @enderror"
            rows="3" placeholder="Detail keperluan izin" required>{{ old('ijin_purpose', '') }}</textarea>
        @error('ijin_purpose')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-3">
        <label class="form-label">Tanggal Awal <span class="text-danger">*</span></label>
        <input type="date" name="date_start" id="date_start" class="form-control @error('date_start') is-invalid @enderror"
            value="{{ old('date_start', $data['date_start'] ?? '') }}" required>
        @error('date_start')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
    </div>
    <div class="col-md-3">
        <label class="form-label">Sampai Tanggal <span class="text-danger">*</span></label>
        <input type="date" name="date_end" id="date_end" class="form-control @error('date_end') is-invalid @enderror"
            value="{{ old('date_end', $data['date_end'] ?? '') }}" readonly>
        @error('date_end')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
        <small class="text-muted">Otomatis dihitung dari Tanggal Awal + Selama</small>
    </div>
    <div class="col-md-6" id="purpose_field">
        <label class="form-label">Keperluan <span class="text-danger">*</span></label>
        <input type="text" name="purpose" class="form-control @error('purpose') is-invalid @enderror"
            value="{{ old('purpose', $data['purpose'] ?? '') }}" placeholder="Alasan tidak masuk kerja" required>
        @error('purpose')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
    </div>
</div>

<!-- Sisa Cuti Tahunan (hanya tampil untuk Cuti Tahunan) -->
<div class="row mb-3" id="remaining_leave_section" style="display: none;">
    <div class="col-12">
        <div class="alert alert-info">
            <h6 class="alert-heading">
                <i class="mdi mdi-information me-2"></i>Informasi Cuti Tahunan
            </h6>
            <p class="mb-2">
                <strong>Sisa cuti tahunan Anda akan dipotong</strong> sesuai dengan durasi cuti yang diajukan.
            </p>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Sisa Cuti Tahunan</label>
                    <div class="input-group">
                        <input type="number" name="remaining_annual_leave" id="remaining_annual_leave"
                            class="form-control @error('remaining_annual_leave') is-invalid @enderror"
                            value="{{ old('remaining_annual_leave', $data['remaining_annual_leave'] ?? $data['remainingAnnualLeave'] ?? 0) }}"
                            min="0" readonly>
                        <span class="input-group-text">hari</span>
                    </div>
                    @error('remaining_annual_leave')
                        <div class="invalid-feedback">{{ $message }}</div>
                    @enderror
                </div>
                <div class="col-md-6">
                    <label class="form-label">Akan Dipotong</label>
                    <div class="input-group">
                        <input type="text" id="leave_deduction" class="form-control" readonly
                            value="- hari">
                        <span class="input-group-text">hari</span>
                    </div>
                    <small class="text-muted">Sesuai durasi cuti yang diajukan</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Field HPL untuk Cuti Hamil -->
<div class="row mb-3" id="hpl_section" style="display: none;">
    <div class="col-md-6">
        <label class="form-label">HPL (Hari Perkiraan Lahir) <span class="text-danger">*</span></label>
        <input type="date" name="hpl_date" id="hpl_date" class="form-control @error('hpl_date') is-invalid @enderror"
            value="{{ old('hpl_date', $data['hpl_date'] ?? '') }}">
        @error('hpl_date')
            <div class="invalid-feedback">{{ $message }}</div>
        @enderror
        <small class="text-muted">Tanggal izin harus dalam rentang 1.5 bulan sebelum HPL sampai 1.5 bulan setelah HPL</small>
    </div>
</div>

@section('scripts')
<script>
// Absence Settings dari Database (Master Settings)
const absenceSettings = @json($data['absenceSettings'] ?? []);

document.addEventListener('DOMContentLoaded', function() {
    const absenceType = document.getElementById('absence_type');
    const deadlineInfo = document.getElementById('deadline_info');
    const deadlineText = document.getElementById('deadline_text');
    const remainingLeaveSection = document.getElementById('remaining_leave_section');
    const cutiKhususCategory = document.getElementById('cuti_khusus_category');
    const cutiKhususCategorySelect = document.getElementById('cuti_khusus_category_select');
    const cutiKhususOther = document.getElementById('cuti_khusus_other');
    const cutiKhususOtherText = document.getElementById('cuti_khusus_other_text');
    const dinasPurpose = document.getElementById('dinas_purpose');
    const ijinDetail = document.getElementById('ijin_detail');
    const ijinCategory = document.getElementById('ijin_category');
    const ijinPurposeField = document.getElementById('ijin_purpose_field');
    const ijinPurpose = document.getElementById('ijin_purpose');
    const deadlineInfoField = document.getElementById('deadline_info');
    const durationDays = document.getElementById('duration_days');
    const purposeField = document.getElementById('purpose_field');
    const ijinDescription = document.getElementById('ijin_description');
    const genderField = document.querySelector('input[name="gender"]');
    const hplSection = document.getElementById('hpl_section');
    const hplDate = document.getElementById('hpl_date');
    const attachmentField = document.querySelector('input[name="attachment"]');
    const attachmentLabel = document.getElementById('attachment_label');
    const dateStart = document.getElementById('date_start');
    const dateEnd = document.getElementById('date_end');

    // Fungsi untuk update label attachment dengan tanda bintang merah jika required
    function updateAttachmentLabel() {
        if (attachmentLabel) {
            // alert('updateAttachmentLabel');
            if (attachmentField && attachmentField.hasAttribute('required')) {
                // Tambahkan tanda bintang merah jika required
                if ($('#attachment_label').length > 0) {
                    $('#attachment_label').html('Lampiran <span class="text-danger">*</span>');
                }
            } else {
                // Hapus tanda bintang merah jika tidak required
                $('#attachment_label').html('Lampiran');

            }
        }
    }

    // Durasi otomatis untuk Cuti Khusus
    const cutiKhususDurations = {
        'Pernikahan Karyawan': 3,
        'Mengkhitankan/Membaptis Anak': 2,
        'Pernikahan Anak Karyawan': 2,
        'Kematian Anak/Suami/Istri': 2,
        'Kematian Ayah/Ibu/Mertua/Menantu': 2,
        'Kematian Orang Serumah': 1,
        'Persalinan Istri/Keguguran': 2
    };

    // Filter opsi izin berdasarkan jenis kelamin
    function filterAbsenceTypeOptions() {
        const gender = genderField ? genderField.value.toLowerCase().trim() : '';
        const isFemale = gender.includes('perempuan') || gender.includes('wanita') || gender === 'p' || gender.includes('female');

        // Dapatkan semua opsi
        const options = absenceType.querySelectorAll('option');

        options.forEach(option => {
            const value = option.value;
            // Cuti Haid dan Cuti Hamil hanya untuk wanita
            if (value === 'Cuti Haid' || value === 'Cuti Hamil') {
                if (!isFemale) {
                    option.style.display = 'none';
                    // Jika opsi yang dipilih adalah Cuti Haid atau Cuti Hamil, reset pilihan
                    if (absenceType.value === value) {
                        absenceType.value = '';
                        updateForm();
                    }
                } else {
                    option.style.display = 'block';
                }
            }
        });
    }

    // Panggil filter saat halaman dimuat
    filterAbsenceTypeOptions();

    function updateForm() {
        const selectedType = absenceType.value;

        // Reset semua conditional fields
        remainingLeaveSection.style.display = 'none';
        cutiKhususCategory.style.display = 'none';
        cutiKhususOther.style.display = 'none';
        dinasPurpose.style.display = 'none';
        ijinDetail.style.display = 'none';
        deadlineInfo.style.display = 'none';
        deadlineInfoField.style.display = 'none';
        hplSection.style.display = 'none';

        // Reset HPL required
        if (hplDate) {
            hplDate.removeAttribute('required');
        }

        // Reset attachment required
        if (attachmentField) {
            attachmentField.removeAttribute('required');
        }
        // Update label attachment
        updateAttachmentLabel();

        // Reset readonly untuk date fields (kecuali date_end yang selalu readonly)
        if (dateStart) {
            dateStart.removeAttribute('readonly');
        }
        // dateEnd selalu readonly karena dihitung otomatis

        // Set required untuk field
        if (cutiKhususCategorySelect) {
            cutiKhususCategorySelect.removeAttribute('required');
        }
        if (cutiKhususOtherText) {
            cutiKhususOtherText.removeAttribute('required');
        }
        if (ijinDescription) {
            ijinDescription.removeAttribute('required');
        }

        // Reset dinas fields
        const dinasCategory = document.getElementById('dinas_category');
        const dinasPurposeInput = document.getElementById('dinas_purpose_input');
        if (dinasCategory) {
            dinasCategory.removeAttribute('required');
        }
        if (dinasPurposeInput) {
            dinasPurposeInput.removeAttribute('required');
        }

        // Reset ijin fields
        if (ijinPurposeField) {
            ijinPurposeField.style.display = 'none';
        }
        if (ijinCategory) {
            ijinCategory.removeAttribute('required');
        }
        if (ijinPurpose) {
            ijinPurpose.removeAttribute('required');
        }

        // Remove required dari purpose field dulu, akan di-set ulang jika diperlukan
        const purposeInput = purposeField.querySelector('input[name="purpose"]');
        if (purposeInput) {
            purposeInput.removeAttribute('required');
        }

        // Show purpose field by default
        purposeField.style.display = 'block';

        // Set min date untuk date_start berdasarkan deadline requirement
        const today = new Date();
        let minDate = today.toISOString().split('T')[0]; // Default: hari ini

        console.log('selectedType: ', selectedType);
        switch(selectedType) {
            case 'Dinas':
                deadlineText.textContent = 'Pengajuan harus H-1 (1 hari sebelum tanggal izin)';
                deadlineInfo.style.display = 'block';
                dinasPurpose.style.display = 'block';
                // Set required untuk dinas_category dan dinas_purpose
                const dinasCategory = document.getElementById('dinas_category');
                const dinasPurposeInput = document.getElementById('dinas_purpose_input');
                if (dinasCategory) {
                    dinasCategory.setAttribute('required', 'required');
                }
                if (dinasPurposeInput) {
                    dinasPurposeInput.setAttribute('required', 'required');
                }
                // Set required untuk attachment (lampiran wajib)
                if (attachmentField) {
                    attachmentField.setAttribute('required', 'required');
                }
                updateAttachmentLabel();
                // Hide default purpose field untuk Dinas
                purposeField.style.display = 'none';
                const purposeInputDinas = purposeField.querySelector('input[name="purpose"]');
                if (purposeInputDinas) {
                    purposeInputDinas.removeAttribute('required');
                }
                // Set min date untuk H-1: besok
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                minDate = tomorrow.toISOString().split('T')[0];
                if (dateStart) {
                    dateStart.setAttribute('min', minDate);
                }
                break;

            case 'Cuti Tahunan':
                deadlineText.textContent = 'Pengajuan harus H-7 (7 hari sebelum tanggal izin)';
                deadlineInfo.style.display = 'block';
                remainingLeaveSection.style.display = 'block';
                // Update leave deduction field
                updateLeaveDeduction();

                // Set required untuk attachment (lampiran wajib)
                // if (attachmentField) {
                //     attachmentField.setAttribute('required', 'required');
                // }

                // updateAttachmentLabel();
                // Set required untuk purpose field
                const purposeInputCutiTahunan = purposeField.querySelector('input[name="purpose"]');
                if (purposeInputCutiTahunan) {
                    purposeInputCutiTahunan.setAttribute('required', 'required');
                }
                // Set min date untuk H-7: 7 hari dari sekarang
                const sevenDays = new Date(today);
                sevenDays.setDate(today.getDate() + 7);
                minDate = sevenDays.toISOString().split('T')[0];
                if (dateStart) {
                    dateStart.setAttribute('min', minDate);
                }

                break;

            case 'Cuti Khusus':
                cutiKhususCategory.style.display = 'block';
                if (cutiKhususCategorySelect) {
                    cutiKhususCategorySelect.setAttribute('required', 'required');
                }
                purposeField.style.display = 'none'; // Hide default purpose field
                // Remove required dari purpose field karena tersembunyi
                const purposeInput = purposeField.querySelector('input[name="purpose"]');
                if (purposeInput) {
                    purposeInput.removeAttribute('required');
                }
                // Set required untuk attachment (lampiran wajib)
                if (attachmentField) {
                    attachmentField.setAttribute('required', 'required');
                }
                updateAttachmentLabel();
                // Cuti Khusus tidak ada deadline requirement, tapi tetap set min = today
                if (dateStart) {
                    dateStart.setAttribute('min', minDate);
                }


                break;

            case 'Cuti Haid':
                deadlineText.textContent = 'Pengajuan maksimal H+1 (1 hari setelah tanggal izin). Wajib melampirkan surat dokter. Waktu cuti 3 bulan total.';
                deadlineInfo.style.display = 'block';
                // Cuti Haid: durasi otomatis 90 hari (3 bulan)
                if (durationDays) {
                    durationDays.value = 90;
                    durationDays.readOnly = true; // Lock karena sudah ditentukan
                }
                // Hide purpose field untuk Cuti Haid
                purposeField.style.display = 'none';
                const purposeInputCutiHaid = purposeField.querySelector('input[name="purpose"]');
                if (purposeInputCutiHaid) {
                    purposeInputCutiHaid.removeAttribute('required');
                }
                // Set required untuk attachment
                if (attachmentField) {
                    attachmentField.setAttribute('required', 'required');
                }
                updateAttachmentLabel();
                // Tidak set min/max date di HTML, validasi dilakukan di JavaScript saja
                // Ini memungkinkan user memilih tanggal yang sudah lewat, tapi akan divalidasi saat submit
                if (dateStart) {
                    dateStart.removeAttribute('min');
                    dateStart.removeAttribute('max');
                }
                break;

            case 'Cuti Hamil':
                deadlineText.textContent = 'Waktu cuti 3 bulan total (1.5 bulan sebelum HPL sampai 1.5 bulan setelah HPL). Tanggal awal dan akhir dihitung otomatis dari HPL. Wajib mengisi HPL dan melampirkan surat dokter.';
                deadlineInfo.style.display = 'block';
                hplSection.style.display = 'block';
                if (hplDate) {
                    hplDate.setAttribute('required', 'required');
                    // Jika HPL sudah ada, langsung set tanggal awal dan akhir
                    if (hplDate.value) {
                        updateCutiHamilDateRange();
                    }
                }
                // Cuti Hamil: durasi otomatis 90 hari (3 bulan total)
                if (durationDays) {
                    durationDays.value = 90;
                    durationDays.readOnly = true; // Lock karena sudah ditentukan
                }
                // Set readonly untuk date fields karena dihitung otomatis dari HPL
                if (dateStart) {
                    dateStart.setAttribute('readonly', 'readonly');
                }
                if (dateEnd) {
                    dateEnd.setAttribute('readonly', 'readonly');
                }
                // Hide purpose field untuk Cuti Hamil (Keperluan tidak ada)
                purposeField.style.display = 'none';
                const purposeInputCutiHamil = purposeField.querySelector('input[name="purpose"]');
                if (purposeInputCutiHamil) {
                    purposeInputCutiHamil.removeAttribute('required');
                }
                // Set required untuk attachment (lampiran wajib)
                if (attachmentField) {
                    attachmentField.setAttribute('required', 'required');
                }
                updateAttachmentLabel();
                break;

            case 'Ijin':
                ijinDetail.style.display = 'block';
                // Set required untuk Kategori Ijin
                if (ijinCategory) {
                    ijinCategory.setAttribute('required', 'required');
                }
                // Tampilkan field Detail Keperluan
                if (ijinPurposeField) {
                    ijinPurposeField.style.display = 'block';
                }
                // Set required untuk Detail Keperluan
                if (ijinPurpose) {
                    ijinPurpose.setAttribute('required', 'required');
                }
                // Tidak perlu required untuk ijin_description karena akan dikategorikan oleh HR
                if (ijinDescription) {
                    ijinDescription.removeAttribute('required');
                }
                // Hide default purpose field
                purposeField.style.display = 'none';
                // Remove required dari purpose field karena tersembunyi
                const purposeInputIjin = purposeField.querySelector('input[name="purpose"]');
                if (purposeInputIjin) {
                    purposeInputIjin.removeAttribute('required');
                }

                // Ijin: maksimal H+1 atau H-1
                const yesterdayIjin = new Date(today);
                yesterdayIjin.setDate(today.getDate() - 1);
                const tomorrowIjin = new Date(today);
                tomorrowIjin.setDate(today.getDate() + 1);
                if (dateStart) {
                    dateStart.setAttribute('min', yesterdayIjin.toISOString().split('T')[0]);
                    dateStart.setAttribute('max', tomorrowIjin.toISOString().split('T')[0]);
                }
                deadlineText.textContent = 'Pengajuan maksimal H+1 atau H-1 (1 hari setelah atau 1 hari sebelum tanggal izin)';
                deadlineInfo.style.display = 'block';
                break;

            case 'Sakit':
                // Set required untuk purpose field
                const purposeInputSakit = purposeField.querySelector('input[name="purpose"]');
                if (purposeInputSakit) {
                    purposeInputSakit.setAttribute('required', 'required');
                }
                // Set required untuk attachment (surat dokter)
                if (attachmentField) {
                    attachmentField.setAttribute('required', 'required');
                }
                updateAttachmentLabel();
                // Sakit: bisa hari ini atau H+1
                const tomorrowSakit = new Date(today);
                tomorrowSakit.setDate(today.getDate() + 1);
                if (dateStart) {
                    dateStart.setAttribute('min', today.toISOString().split('T')[0]);
                    dateStart.setAttribute('max', tomorrowSakit.toISOString().split('T')[0]);
                }
                deadlineText.textContent = 'Pengajuan dapat dilakukan saat sakit atau H+1 ketika masuk kerja. Wajib melampirkan surat dokter.';
                deadlineInfo.style.display = 'block';
                break;
        }

        // Re-validate deadline setelah update form
        if (dateStart && dateStart.value) {
            validateDeadline();
            // Jika Cuti Hamil, validasi juga berdasarkan HPL
            if (selectedType === 'Cuti Hamil' && hplDate && hplDate.value) {
                validateCutiHamilDate();
            }
        }
    }


    // Update tanggal awal dan akhir untuk Cuti Hamil berdasarkan HPL
    function updateCutiHamilDateRange() {
        if (!dateStart || !dateEnd || !durationDays) return;

        if (!hplDate || !hplDate.value) {
            dateStart.removeAttribute('min');
            dateStart.removeAttribute('max');
            dateStart.value = '';
            dateEnd.value = '';
            return;
        }

        const hpl = new Date(hplDate.value + 'T00:00:00');
        // Hitung 1.5 bulan = 45 hari
        const daysBefore = 45;
        const daysAfter = 45;

        // Tanggal awal = HPL - 1.5 bulan (45 hari)
        const startDate = new Date(hpl);
        startDate.setDate(hpl.getDate() - daysBefore);

        // Tanggal akhir = HPL + 1.5 bulan (45 hari)
        const endDate = new Date(hpl);
        endDate.setDate(hpl.getDate() + daysAfter);

        // Format tanggal ke YYYY-MM-DD
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Set tanggal awal dan akhir otomatis
        dateStart.value = formatDate(startDate);
        dateEnd.value = formatDate(endDate);

        // Set durasi = 90 hari (3 bulan total)
        durationDays.value = 90;

        // Set min dan max date untuk validasi (jika user mencoba mengubah)
        dateStart.setAttribute('min', formatDate(startDate));
        dateStart.setAttribute('max', formatDate(startDate));
        dateEnd.setAttribute('min', formatDate(endDate));
        dateEnd.setAttribute('max', formatDate(endDate));
    }

    // Validasi Cuti Hamil berdasarkan HPL
    function validateCutiHamilDate() {
        if (!hplDate || !hplDate.value || !dateStart || !dateStart.value) return;

        const hpl = new Date(hplDate.value + 'T00:00:00');
        const startDate = new Date(dateStart.value + 'T00:00:00');

        // Hitung 1.5 bulan = 45 hari
        const daysBefore = 45;
        const daysAfter = 45;

        const minDate = new Date(hpl);
        minDate.setDate(hpl.getDate() - daysBefore);
        minDate.setHours(0, 0, 0, 0);

        const maxDate = new Date(hpl);
        maxDate.setDate(hpl.getDate() + daysAfter);
        maxDate.setHours(23, 59, 59, 999);

        startDate.setHours(0, 0, 0, 0);

        if (startDate < minDate || startDate > maxDate) {
            const minDateStr = minDate.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const maxDateStr = maxDate.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });

            dateStart.setCustomValidity(`Tanggal izin harus dalam rentang 1.5 bulan sebelum HPL sampai 1.5 bulan setelah HPL (${minDateStr} - ${maxDateStr})`);
            dateStart.classList.add('is-invalid');

            let errorDiv = dateStart.parentElement.querySelector('.hpl-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback hpl-error';
                dateStart.parentElement.appendChild(errorDiv);
            }
            errorDiv.textContent = `Tanggal izin harus dalam rentang 1.5 bulan sebelum HPL sampai 1.5 bulan setelah HPL (${minDateStr} - ${maxDateStr})`;
        } else {
            dateStart.setCustomValidity('');
            dateStart.classList.remove('is-invalid');

            const errorDiv = dateStart.parentElement.querySelector('.hpl-error');
            if (errorDiv) {
                errorDiv.remove();
            }
        }
    }

    // Event listener untuk HPL date change
    if (hplDate) {
        hplDate.addEventListener('change', function() {
            if (absenceType.value === 'Cuti Hamil') {
                updateCutiHamilDateRange();
            }
        });
    }

    // Handle Cuti Khusus category change
    if (cutiKhususCategorySelect) {
        cutiKhususCategorySelect.addEventListener('change', function() {
            const category = this.value;

            if (category === 'Lainnya') {
                if (cutiKhususOther) {
                    cutiKhususOther.style.display = 'block';
                }
                if (cutiKhususOtherText) {
                    cutiKhususOtherText.setAttribute('required', 'required');
                }
                if (durationDays) {
                    durationDays.value = '';
                    durationDays.readOnly = false;
                }
            } else {
                if (cutiKhususOther) {
                    cutiKhususOther.style.display = 'none';
                }
                if (cutiKhususOtherText) {
                    cutiKhususOtherText.removeAttribute('required');
                }

                // Set duration automatically sesuai kategori
                if (cutiKhususDurations[category] && durationDays) {
                    durationDays.value = cutiKhususDurations[category];
                    durationDays.readOnly = true; // Lock karena sudah ditentukan
                }
            }
        });
    }

    // Auto-calculate date_end based on date_start and duration_days
    function calculateDateEnd() {
        // Jangan hitung untuk Cuti Hamil karena tanggal dihitung otomatis dari HPL
        if (absenceType && absenceType.value === 'Cuti Hamil') {
            return;
        }

        if (dateStart && dateEnd && dateStart.value && durationDays && durationDays.value) {
            const startDate = new Date(dateStart.value);
            const duration = parseInt(durationDays.value) || 1;
            const endDate = new Date(startDate);

            // Untuk semua jenis: Tanggal Awal + Selama - 1 (karena tanggal awal sudah termasuk)
            endDate.setDate(startDate.getDate() + duration - 1);

            // Format as YYYY-MM-DD
            const year = endDate.getFullYear();
            const month = String(endDate.getMonth() + 1).padStart(2, '0');
            const day = String(endDate.getDate()).padStart(2, '0');
            dateEnd.value = `${year}-${month}-${day}`;
        }
    }

    // Update leave deduction field untuk Cuti Tahunan
    function updateLeaveDeduction() {
        const leaveDeductionField = document.getElementById('leave_deduction');
        if (!leaveDeductionField) return;

        if (durationDays && durationDays.value) {
            const duration = parseInt(durationDays.value) || 0;
            leaveDeductionField.value = `${duration} hari`;
        } else {
            leaveDeductionField.value = '- hari';
        }
    }

    // Calculate date_end when date_start or duration_days changes
    if (dateStart) {
        dateStart.addEventListener('change', calculateDateEnd);
    }
    if (durationDays) {
        durationDays.addEventListener('change', function() {
            // Pastikan durasi Cuti Hamil selalu 90 hari (3 bulan)
            if (absenceType && absenceType.value === 'Cuti Hamil') {
                if (durationDays.value !== '90') {
                    durationDays.value = 90;
                }
            }
            // Pastikan durasi Cuti Haid selalu 90 hari (3 bulan)
            if (absenceType && absenceType.value === 'Cuti Haid') {
                if (durationDays.value !== '90') {
                    durationDays.value = 90;
                }
            }
            calculateDateEnd();
            updateLeaveDeduction();
        });
    }

    // Validate deadline saat date_start diubah
    if (dateStart) {
        dateStart.addEventListener('change', function() {
            validateDeadline();
            // Jika Cuti Hamil, validasi juga berdasarkan HPL
            if (absenceType && absenceType.value === 'Cuti Hamil' && hplDate && hplDate.value) {
                validateCutiHamilDate();
            }
        });
    }

    function validateDeadline() {
        if (!dateStart || !dateStart.value || !absenceType || !absenceType.value) return;

        const selectedType = absenceType.value;

        // Cuti Hamil hanya menggunakan validasi HPL, tidak ada validasi deadline H-7
        if (selectedType === 'Cuti Hamil') {
            validateCutiHamilDate();
            return;
        }

        const startDate = new Date(dateStart.value + 'T00:00:00');
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Calculate difference in days (date_start - today)
        // Positive = date_start is in the future, negative = date_start is in the past
        const diffTime = startDate.getTime() - today.getTime();
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        let minDays = 0;
        let maxDays = null;
        let deadlineType = '';
        let errorMessage = '';

        switch(selectedType) {
            case 'Dinas':
                minDays = 1;
                deadlineType = 'H-1';
                break;
            case 'Cuti Tahunan':
                minDays = 7;
                deadlineType = 'H-7';
                break;
            case 'Cuti Haid':
                // Maksimal H+1 (1 hari setelah hari ini)
                maxDays = 1;
                deadlineType = 'H+1';
                if (diffDays > maxDays) {
                    const maxAllowedDate = new Date(today);
                    maxAllowedDate.setDate(today.getDate() + maxDays);
                    const maxDateStr = maxAllowedDate.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    errorMessage = `Pengajuan Cuti Haid maksimal ${deadlineType} (${maxDays} hari setelah tanggal izin). Tanggal izin maksimal ${maxDateStr}`;
                }
                break;
            case 'Ijin':
                // Ijin: maksimal H+1 atau H-1
                maxDays = 1;
                const minDaysIjin = -1;
                if (diffDays > maxDays || diffDays < minDaysIjin) {
                    errorMessage = 'Pengajuan Ijin maksimal H+1 atau H-1 (1 hari setelah atau 1 hari sebelum tanggal izin)';
                }
                break;
            case 'Sakit':
                // Sakit: bisa hari ini atau H+1
                maxDays = 1;
                if (diffDays > maxDays) {
                    errorMessage = `Pengajuan Sakit maksimal H+1 (${maxDays} hari setelah tanggal izin). Tanggal izin maksimal ${today.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                }
                break;
        }

        // Validasi untuk deadline minimum (TIDAK untuk Cuti Hamil karena sudah di-handle di atas)
        if (minDays > 0 && diffDays < minDays) {
            // Calculate minimum allowed date
            const minDate = new Date(today);
            minDate.setDate(today.getDate() + minDays);
            const minDateStr = minDate.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });

            errorMessage = `Pengajuan ${selectedType} harus minimal ${deadlineType} (${minDays} hari sebelum tanggal izin). Tanggal izin minimal ${minDateStr}`;
        }

        // Tampilkan error jika ada
        if (errorMessage) {
            dateStart.setCustomValidity(errorMessage);
            dateStart.classList.add('is-invalid');

            // Show error message
            let errorDiv = dateStart.parentElement.querySelector('.deadline-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback deadline-error';
                dateStart.parentElement.appendChild(errorDiv);
            }
            errorDiv.textContent = errorMessage;
        } else {
            dateStart.setCustomValidity('');
            dateStart.classList.remove('is-invalid');

            // Remove error message
            const errorDiv = dateStart.parentElement.querySelector('.deadline-error');
            if (errorDiv) {
                errorDiv.remove();
            }
        }
    }


    // Main event listener
    if (absenceType) {
        absenceType.addEventListener('change', function() {
            updateForm();
            // Validate deadline setelah update form
            if (dateStart && dateStart.value) {
                validateDeadline();
            }
        });
    }

    // Initial call
    updateForm();
    // Update label attachment setelah initial form update
    updateAttachmentLabel();

    // Validate deadline saat absence_type sudah terisi dan date_start sudah ada
    if (absenceType && absenceType.value && dateStart && dateStart.value) {
        validateDeadline();
    }

    // Filter opsi saat jenis kelamin berubah (jika field bisa diubah)
    if (genderField) {
        // Catat: field gender adalah readonly, tapi kita filter saat load
        // Jika nanti field gender bisa diubah, uncomment baris berikut:
        // genderField.addEventListener('change', function() {
        //     filterAbsenceTypeOptions();
        //     if (absenceType.value === 'Cuti Haid' || absenceType.value === 'Cuti Hamil') {
        //         absenceType.value = '';
        //         updateForm();
        //     }
        // });
    }

    const absenceFormElement = document.querySelector('form[action="{{ route('hr.requests.store') }}"]');
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    if (absenceFormElement) {
        const requestTypeInput = absenceFormElement.querySelector('input[name="request_type"]');

        if (requestTypeInput && requestTypeInput.value === 'absence') {
            const submitButton = absenceFormElement.querySelector('button[type="submit"]');
            const originalButtonHtml = submitButton ? submitButton.innerHTML : '';

            const resetSubmitButton = () => {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonHtml;
                }
            };

            const showValidationErrors = (errors) => {
                const messages = [];
                Object.values(errors || {}).forEach((msgs) => {
                    messages.push(...msgs);
                });

                if (messages.length) {
                    Swal.fire({
                        title: 'Validasi Error',
                        html: messages.join('<br>'),
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            };

            const submitAbsenceWithConfirmation = () => {
                const confirmData = new FormData(absenceFormElement);

                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...';
                }

                fetch('{{ route('hr.requests.store.confirm') }}', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken,
                        'Accept': 'application/json'
                    },
                    body: confirmData
                })
                .then(async (response) => {
                    if (response.ok) {
                        return response.json();
                    }

                    if (response.status === 422) {
                        const data = await response.json();
                        showValidationErrors(data.errors || {});
                        throw new Error('validation');
                    }

                    const data = await response.json().catch(() => ({}));
                    const message = data.message || 'Terjadi kesalahan saat menyimpan data.';
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: message,
                        confirmButtonText: 'OK'
                    });
                    throw new Error('request-failed');
                })
                .then((data) => {
                    Swal.fire({
                        title: 'Berhasil!',
                        text: data.message || 'Pengajuan berhasil dibuat',
                        icon: 'success',
                        confirmButtonText: 'OK',
                        timer: 3000,
                        timerProgressBar: true
                    }).then(() => {
                        window.location.href = data.redirect || '{{ route('hr.requests.index') }}';
                    });
                })
                .catch((error) => {
                    if (error.message !== 'validation' && error.message !== 'request-failed') {
                        console.error(error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Terjadi kesalahan saat menyimpan data.',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .finally(() => {
                    resetSubmitButton();
                });
            };

            absenceFormElement.addEventListener('submit', function(event) {
                event.preventDefault();

                if (!submitButton) {
                    absenceFormElement.submit();
                    return;
                }

                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Mengecek...';

                const formData = new FormData(absenceFormElement);

                fetch(absenceFormElement.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken,
                        'Accept': 'application/json'
                    },
                    body: formData
                })
                .then(async (response) => {
                    if (response.ok) {
                        return response.json();
                    }

                    if (response.status === 422) {
                        const data = await response.json();
                        showValidationErrors(data.errors || {});
                        throw new Error('validation');
                    }

                    const data = await response.json().catch(() => ({}));
                    const message = data.message || 'Terjadi kesalahan saat mengirim data.';
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: message,
                        confirmButtonText: 'OK'
                    });
                    throw new Error('request-failed');
                })
                .then((data) => {
                    if (data.is_holiday) {
                        const holidayList = (data.holiday_dates || []).map((item) => {
                            const dateLabel = item.date_label || item.date;
                            const name = item.holiday_name ? ` (${item.holiday_name})` : '';
                            return `${dateLabel}${name}`;
                        }).join('<br>');

                        const messageHtml = data.message || 'Tanggal yang dipilih termasuk hari libur.';

                        Swal.fire({
                            title: 'Konfirmasi Tanggal',
                            html: holidayList ? `${messageHtml}<br><br>${holidayList}` : messageHtml,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Ya, Lanjutkan',
                            cancelButtonText: 'Batal',
                            reverseButtons: true
                        }).then((result) => {
                            if (result.isConfirmed) {
                                submitAbsenceWithConfirmation();
                            } else {
                                resetSubmitButton();
                            }
                        });
                    } else if (data.success) {
                        Swal.fire({
                            title: 'Berhasil!',
                            text: data.message || 'Pengajuan berhasil dibuat',
                            icon: 'success',
                            confirmButtonText: 'OK',
                            timer: 3000,
                            timerProgressBar: true
                        }).then(() => {
                            window.location.href = data.redirect || '{{ route('hr.requests.index') }}';
                        });
                    } else {
                        const message = data.message || 'Terjadi kesalahan saat mengirim data.';
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: message,
                            confirmButtonText: 'OK'
                        });
                        resetSubmitButton();
                    }
                })
                .catch((error) => {
                    if (error.message !== 'validation' && error.message !== 'request-failed') {
                        console.error(error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Terjadi kesalahan saat mengirim data.',
                            confirmButtonText: 'OK'
                        });
                    }

                    resetSubmitButton();
                });
            });
        }
    }
});
</script>
@endsection
